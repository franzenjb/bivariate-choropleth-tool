<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>American Red Cross Bivariate Analysis Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #ffffff;
            color: #333;
        }
        
        .header {
            background: #B71C1C;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 20px;
            margin-top: 20px;
            transition: grid-template-columns 0.3s ease;
        }
        
        .main-grid.demo-collapsed {
            grid-template-columns: 350px 1fr 50px;
        }
        
        .demo-panel {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            position: relative;
        }
        
        .demo-panel h3 {
            background: #B71C1C;
            color: white;
            margin: -20px -20px 15px -20px;
            padding: 15px 20px;
            border-radius: 4px 4px 0 0;
            font-size: 14px;
            font-weight: normal;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .demo-close-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .demo-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        
        .demo-panel.collapsed {
            width: 50px;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .demo-panel.collapsed:hover {
            background: #e9ecef;
        }
        
        .demo-panel.collapsed h3 {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 20px 8px;
            margin: 0;
            height: 100%;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
        }
        
        .control-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 25px;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .map-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
        }
        
        #map {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            min-height: 500px;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .section:last-child { border-bottom: none; }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab:hover { color: #B71C1C; }
        
        .tab.active {
            color: white;
            background: #B71C1C;
            border-bottom-color: #B71C1C;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        input[type="file"], input[type="text"], input[type="url"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
            margin-top: 8px;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #B71C1C;
            outline: none;
        }
        
        button {
            background: #B71C1C;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
            margin: 5px;
        }
        
        button:hover {
            background: #8B0000;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);
        }
        
        .success-button {
            background: #666;
        }
        
        .success-button:hover {
            background: #555;
        }
        
        .info-button {
            background: #666;
        }
        
        .info-button:hover {
            background: #555;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            width: 150px;
            height: 150px;
            margin: 20px auto;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .legend-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            animation: slideIn 0.3s;
        }
        
        .status-message.success {
            background: #c8e6c9;
            color: #2e7d32;
            border: 1px solid #4caf50;
            display: block;
        }
        
        .status-message.error {
            background: #ffcdd2;
            color: #c62828;
            border: 1px solid #f44336;
            display: block;
        }
        
        .status-message.info {
            background: #bbdefb;
            color: #1565c0;
            border: 1px solid #2196f3;
            display: block;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .field-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            background: #f5f5f5;
        }
        
        .field-item {
            padding: 8px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .field-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #B71C1C;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .service-preset {
            padding: 12px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px 0;
            transition: background 0.2s, border 0.2s;
        }
        
        .service-preset:hover {
            background: #f5f5f5;
            border-color: #B71C1C;
        }
        
        .correlation-meter {
            height: 30px;
            background: linear-gradient(90deg, #f44336, #ffeb3b, #4caf50);
            border-radius: 15px;
            position: relative;
            margin: 15px 0;
        }
        
        .correlation-indicator {
            position: absolute;
            top: -5px;
            width: 40px;
            height: 40px;
            background: white;
            border: 3px solid #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: left 0.5s ease;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #B71C1C;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .quadrant-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .quadrant-box {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        
        .quadrant-high-high { background: #90508B; }
        .quadrant-high-low { background: #73AE7F; }
        .quadrant-low-high { background: #C8B8D6; }
        .quadrant-low-low { background: #E8E8E8; color: #333; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Bivariate Choropleth Analysis Tool</h1>
        <p>ArcGIS Integration for Advanced Geographic Analysis</p>
    </div>

    <div class="container">
        <div class="main-grid">
            <div class="control-panel">
                <!-- Removed demo section from main tool panel -->
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('arcgis', event)">ArcGIS</button>
                    <button class="tab" onclick="switchTab('csv', event)">CSV Upload</button>
                    <button class="tab" onclick="switchTab('manual', event)">Manual URL</button>
                </div>

                <!-- ArcGIS Tab -->
                <div id="arcgis-tab" class="tab-content active">
                    <!-- X/Y Variable Selection - Top Priority -->
                    <div class="section" id="arcgisVariableSelection" style="display: none;">
                        <h3>📊 Create Bivariate Map</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label>X-Axis Variable:</label>
                            <select id="arcgisXVariable" title="Choose your first variable - all available demographic fields will appear here after loading geography data">
                                <option value="">-- Select X Variable --</option>
                            </select>
                            <div class="help-text" style="font-size: 11px; color: #666; margin-top: 5px;">📊 This dropdown will show ALL demographic fields (income, population, age, etc.) after you load geography data below</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>Y-Axis Variable:</label>
                            <select id="arcgisYVariable" title="Choose your second variable to compare against the X variable">
                                <option value="">-- Select Y Variable --</option>
                            </select>
                            <div class="help-text" style="font-size: 11px; color: #666; margin-top: 5px;">📈 Choose a different variable to create your bivariate comparison</div>
                        </div>
                        
                        <button onclick="generateBivariateMap()" style="width: 100%; padding: 15px; font-size: 16px; background: #B71C1C; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px;">
                            Generate Bivariate Map
                        </button>
                    </div>

                    <div class="section">
                        <h3>Quick Connect
                            <button onclick="resetArcGISTab()" style="float: right; background: #666; padding: 6px 12px; font-size: 12px;">Reset</button>
                        </h3>
                        <div style="background: #f0f8ff; border: 1px solid #B71C1C; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 8px 0; color: #B71C1C; font-size: 14px;">📋 Quick Start:</h4>
                            <ol style="margin: 0; padding-left: 18px; font-size: 12px; color: #333;">
                                <li><strong>Click a geography below</strong> (e.g., "Counties" loads 3,142 counties with 60+ demographic fields)</li>
                                <li><strong>Wait for fields to load</strong> - you'll see "Found X data fields" when ready</li>
                                <li><strong>Choose X and Y variables</strong> from the dropdowns (now with all demographic options)</li>
                                <li><strong>Click "Generate Bivariate Map"</strong> to see your analysis</li>
                            </ol>
                        </div>
                        <p style="color: #666; font-size: 12px; margin: 10px 0;">Select a geography layer to load with full demographics:</p>
                        <div class="service-preset" onclick="loadARCCounties()" style="background: #f9f9f9; border: 1px solid #ddd; cursor: pointer; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                            <div>
                            <div><strong>Counties</strong></div>
                            <div class="help-text" style="font-size: 12px; color: #666;">3,142 US counties with demographics</div>
                            </div>
                        </div>
                        <div class="service-preset" onclick="loadRedCrossDivisions()" style="background: #f9f9f9; border: 1px solid #ddd; cursor: pointer; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                            <div>
                            <div><strong>Divisions</strong></div>
                            <div class="help-text" style="font-size: 12px; color: #666;">7 Red Cross divisions</div>
                            </div>
                        </div>
                        <div class="service-preset" onclick="loadRedCrossRegions()" style="background: #f9f9f9; border: 1px solid #ddd; cursor: pointer; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                            <div>
                            <div><strong>Regions</strong></div>
                            <div class="help-text" style="font-size: 12px; color: #666;">59 Red Cross regions</div>
                            </div>
                        </div>
                        <div class="service-preset" onclick="loadRedCrossChapters()" style="background: #f9f9f9; border: 1px solid #ddd; cursor: pointer; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                            <div>
                            <div><strong>Chapters</strong></div>
                            <div class="help-text" style="font-size: 12px; color: #666;">Red Cross local chapters</div>
                            </div>
                        </div>
                        <div class="service-preset" onclick="loadARCStates()" style="background: #f9f9f9; border: 1px solid #ddd; cursor: pointer; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                            <div>
                            <div><strong>States</strong></div>
                            <div class="help-text" style="font-size: 12px; color: #666;">50 US states</div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Service Accordion -->
                    <div class="section">
                        <div style="cursor: pointer; padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; font-weight: bold; color: #495057;" onclick="toggleAccordion('customArcGISAccordion')">
                            <span>🌐 Custom ArcGIS Service & Service by ID</span>
                            <span id="customArcGISAccordion_arrow" style="float: right; transition: transform 0.2s;">▼</span>
                        </div>
                        <div id="customArcGISAccordion" style="display: none; border: 1px solid #dee2e6; border-top: none; background: white; padding: 15px; border-radius: 0 0 4px 4px;">
                            
                            <h4 style="margin: 0 0 10px 0; color: #B71C1C;">Custom ArcGIS Service</h4>
                            <input type="url" id="customServiceUrl" placeholder="https://services.arcgis.com/.../FeatureServer/0" style="width: 100%; margin-bottom: 5px;">
                            <div class="help-text" style="margin-bottom: 10px;">Enter your ArcGIS Feature Service URL (must be public)</div>
                            <button onclick="loadCustomService()" class="info-button" style="width: 100%; margin-bottom: 20px;">
                                Connect to Service
                            </button>

                            <h4 style="margin: 0 0 10px 0; color: #B71C1C;">Service by ID</h4>
                            <input type="text" id="serviceId" placeholder="Enter service ID or item ID" style="width: 100%; margin-bottom: 10px;">
                            <select id="orgSelect" style="width: 100%; margin-bottom: 10px;">
                                <option value="8DAUcrpQcpyLMznu">Red Cross Organization</option>
                                <option value="V6ZHFr6zdgNZuVG0">Public Demographics</option>
                                <option value="P3ePLMYs2RVChkJx">ESRI Public</option>
                                <option value="custom">Custom Org ID</option>
                            </select>
                            <input type="text" id="customOrgId" placeholder="Custom org ID" style="display: none; width: 100%; margin-bottom: 10px;">
                            <button onclick="loadServiceById()" class="info-button" style="width: 100%;">
                                Load by ID
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CSV Upload Tab -->
                <div id="csv-tab" class="tab-content">
                    <div class="section">
                        <h3>📁 Upload CSV Data
                            <button onclick="resetCSVTab()" style="float: right; background: #ff5722; padding: 6px 12px; font-size: 12px;">Reset</button>
                        </h3>
                        <div style="background: #f0f8ff; border: 1px solid #B71C1C; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 8px 0; color: #B71C1C; font-size: 14px;">📋 How to Use This Tool:</h4>
                            <ol style="margin: 0; padding-left: 18px; font-size: 12px; color: #333;">
                                <li><strong>First:</strong> Upload your CSV file with data you want to analyze</li>
                                <li><strong>Then:</strong> Select which geography to match your data to (counties, states, etc.)</li>
                                <li><strong>Match:</strong> Connect your CSV field to the geography field</li>
                                <li><strong>Finally:</strong> Choose X and Y variables from BOTH your CSV data AND geography demographics</li>
                            </ol>
                        </div>
                        <input type="file" id="csvFile" accept=".csv">
                        <div class="help-text">Upload a CSV file with data to match to geographic boundaries</div>
                    </div>

                    <div class="section">
                        <h3>Select Geography to Match</h3>
                        <select id="geographyType" onchange="handleGeographyChange()">
                            <option value="">-- Select Geography --</option>
                            <option value="arc_counties">ARC Counties (3,142 counties - match by FIPS/County)</option>
                            <option value="divisions">ARC Divisions (7 divisions - match by name)</option>
                            <option value="regions">ARC Regions (59 regions - match by name)</option>
                            <option value="chapters">ARC Chapters (250+ chapters - match by name)</option>
                            <option value="states">US States (match by State name or abbreviation)</option>
                        </select>
                        <div class="help-text" id="matchHelp" style="margin-top: 10px; display: none;"></div>
                    </div>
                    
                    <div class="section" id="csvFieldMapping" style="display: none;">
                        <h3>🔗 Field Mapping</h3>
                        <label>Match CSV field:</label>
                        <select id="csvMatchField">
                            <option value="">-- Select CSV field to match --</option>
                        </select>
                        <label style="margin-top: 10px;">To geography field:</label>
                        <select id="geoMatchField">
                            <option value="">-- Select geography field --</option>
                        </select>
                        <button onclick="matchAndMergeData()" class="success-button" style="margin-top: 15px; width: 100%;">
                            🔗 Match & Merge Data
                        </button>
                    </div>
                </div>

                <!-- Manual URL Tab -->
                <div id="manual-tab" class="tab-content">
                    <div class="section">
                        <h3>🌐 Direct Service URL
                            <button onclick="resetManualTab()" style="float: right; background: #ff5722; padding: 6px 12px; font-size: 12px;">Reset</button>
                        </h3>
                        <textarea id="directUrl" rows="3" placeholder="Paste full ArcGIS URL here"></textarea>
                        <button onclick="parseAndLoadUrl()" class="info-button" style="margin-top: 10px; width: 100%;">
                            Parse & Load URL
                        </button>
                    </div>
                </div>

                <!-- Field Selection -->
                <div class="section" id="fieldSelection" style="display: none;">
                    <h3>Available Fields
                        <button onclick="resetFieldSelection()" style="float: right; background: #ff5722; padding: 6px 12px; font-size: 12px;">Clear</button>
                    </h3>
                    <div id="fieldCount" class="help-text"></div>
                    <div class="field-list" id="fieldList"></div>
                    
                    <div style="margin-top: 15px;">
                        <label>X-Axis Variable:</label>
                        <select id="xVariable" title="Choose your first variable - all available demographic fields will appear here after loading geography data">
                            <option value="">-- Select X Variable --</option>
                        </select>
                        <div class="help-text" style="font-size: 11px; color: #666; margin-top: 5px;">📊 This dropdown will show ALL demographic fields (income, population, age, etc.) after you load geography data above</div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label>Y-Axis Variable:</label>
                        <select id="yVariable" title="Choose your second variable to compare against the X variable">
                            <option value="">-- Select Y Variable --</option>
                        </select>
                        <div class="help-text" style="font-size: 11px; color: #666; margin-top: 5px;">📈 Choose a different variable to create your bivariate comparison</div>
                    </div>
                    
                    <button onclick="generateBivariateMap()" style="margin-top: 15px; width: 100%; padding: 15px; font-size: 16px; background: #B71C1C; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Generate Bivariate Map
                    </button>
                </div>

                <!-- Legend -->
                <div class="section" id="legendSection" style="display: none;">
                    <h3>🎨 Bivariate Legend</h3>
                    <div style="text-align: center;">
                        <div class="legend-grid" id="legendGrid"></div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span id="xLabel" style="font-size: 12px;">→ X Variable</span>
                            <span id="yLabel" style="font-size: 12px;">↑ Y Variable</span>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="section" id="statsSection" style="display: none;">
                    <h3>📈 Analysis Results</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="correlationValue">--</div>
                            <div class="stat-label">Correlation</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="featureCount">--</div>
                            <div class="stat-label">Features</div>
                        </div>
                    </div>
                    
                    <div class="correlation-meter">
                        <div class="correlation-indicator" id="correlationIndicator">0</div>
                    </div>
                    
                    <div class="quadrant-analysis">
                        <div class="quadrant-box quadrant-high-high">
                            <div>High-High</div>
                            <div id="highHighCount">0</div>
                        </div>
                        <div class="quadrant-box quadrant-high-low">
                            <div>High-Low</div>
                            <div id="highLowCount">0</div>
                        </div>
                        <div class="quadrant-box quadrant-low-high">
                            <div>Low-High</div>
                            <div id="lowHighCount">0</div>
                        </div>
                        <div class="quadrant-box quadrant-low-low">
                            <div>Low-Low</div>
                            <div id="lowLowCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="section" id="exportSection" style="display: none;">
                    <h3>💾 Export Options</h3>
                    <button onclick="exportData('csv')">Export CSV</button>
                    <button onclick="exportData('geojson')">Export GeoJSON</button>
                    <button onclick="exportData('image')">Save Map Image</button>
                </div>
            </div>

            <div class="map-container">
                <div id="status" class="status-message"></div>
                <div style="position: absolute; top: 60px; right: 30px; z-index: 1000; display: flex; gap: 10px;">
                    <select id="basemapSelector" onchange="changeBasemap()" style="padding: 8px; background: white; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Satellite</option>
                        <option value="terrain">Terrain</option>
                        <option value="topo">Topographic</option>
                        <option value="dark">Dark</option>
                        <option value="light">Light Gray</option>
                    </select>
                    <button onclick="resetAll()" style="background: #B71C1C; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Reset All</button>
                </div>
                <div id="map"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Loading data...</p>
                </div>
            </div>
            
            <!-- Demo Panel - Right Side -->
            <div class="demo-panel" id="demoPanel">
                <h3 onclick="toggleDemoPanel()">
                    <span>Examples & Demonstrations</span>
                    <button class="demo-close-btn" onclick="event.stopPropagation(); toggleDemoPanel();">×</button>
                </h3>
                
                <div style="padding: 15px;">
                    <h4 style="margin-bottom: 10px; color: #333;">Quick Demos</h4>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Click to see examples - these are just demonstrations!</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button onclick="quickDemo('divisions')" style="background: white; border: 1px solid #ddd; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px;">
                            <strong>Divisions Example</strong><br>
                            <span style="font-size: 11px; color: #666;">7 divisions with demographics</span>
                        </button>
                        
                        <button onclick="quickDemo('regions')" style="background: white; border: 1px solid #ddd; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px;">
                            <strong>Regions Example</strong><br>
                            <span style="font-size: 11px; color: #666;">59 regions analysis</span>
                        </button>
                        
                        <button onclick="quickDemo('chapters')" style="background: white; border: 1px solid #ddd; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px;">
                            <strong>Chapters Example</strong><br>
                            <span style="font-size: 11px; color: #666;">226 chapters visualization</span>
                        </button>
                        
                        <button onclick="quickDemo('counties')" style="background: white; border: 1px solid #ddd; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px;">
                            <strong>Counties Example</strong><br>
                            <span style="font-size: 11px; color: #666;">3,142 counties (slower)</span>
                        </button>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: #333;">Sample Data Sets</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button onclick="loadFloridaALICEData()" style="background: white; border: 1px solid #B71C1C; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px; color: #333;">
                            <strong style="color: #B71C1C;">Florida ALICE Data</strong><br>
                            <span style="font-size: 11px; color: #666;">Asset Limited households</span>
                        </button>
                        
                        <button onclick="quickDemo('csv-division')" style="background: white; border: 1px solid #666; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px; color: #333;">
                            <strong style="color: #666;">CSV + Geography Demo</strong><br>
                            <span style="font-size: 11px; color: #666;">How to combine data</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: #333;">Sample CSV Data</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Try these sample datasets:</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="loadSampleCSV('divisions')" style="background: #B71C1C; color: white; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px; border: none;">
                                <strong>Sample Division Data</strong><br>
                                <span style="font-size: 11px; opacity: 0.9;">Demo division demographics</span>
                            </button>
                            
                            <button onclick="loadSampleCSV('counties')" style="background: #8B0000; color: white; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px; border: none;">
                                <strong>Sample County Data</strong><br>
                                <span style="font-size: 11px; opacity: 0.9;">Demo county data</span>
                            </button>
                            
                            <button onclick="loadSampleCSV('regions')" style="background: #666; color: white; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px; border: none;">
                                <strong>Sample Region Data</strong><br>
                                <span style="font-size: 11px; opacity: 0.9;">Demo region analytics</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">
                        <h4 style="margin-bottom: 10px; color: #B71C1C;">ALICE Real Data Demos</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Asset Limited, Income Constrained, Employed households</p>
                        
                        <button onclick="loadFloridaALICEData()" style="background: #B71C1C; color: white; padding: 10px; font-size: 13px; margin: 5px 0; width: 100%; font-weight: bold; border: none; border-radius: 4px;">
                            Load 2023 Florida ALICE Data (Manual Steps)
                        </button>
                        
                        <button onclick="runFloridaALICEOneClick()" style="background: #8B0000; color: white; padding: 14px; font-size: 15px; margin: 8px 0; width: 100%; font-weight: bold; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 4px;">
                            ONE-CLICK: Complete Florida ALICE Demo
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px;">
                        <p style="font-size: 11px; color: #333; margin: 0;">
                            <strong>Note:</strong> These are example demonstrations only. For real analysis, use the main tool panel on the left.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let currentLayer;
        let currentData = [];
        let currentFields = [];
        let currentGeometry = null;
        let csvData = null;
        let csvFields = [];
        let matchedGeography = null;

        // Initialize map
        function toggleDemoPanel() {
            const panel = document.getElementById('demoPanel');
            const mainGrid = document.querySelector('.main-grid');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                mainGrid.classList.remove('demo-collapsed');
                // Remove click listener when expanded
                panel.removeEventListener('click', toggleDemoPanel);
            } else {
                panel.classList.add('collapsed');
                mainGrid.classList.add('demo-collapsed');
                // Add click listener when collapsed so users can click to expand
                setTimeout(() => {
                    panel.addEventListener('click', toggleDemoPanel);
                }, 100);
            }
        }
        
        let currentBasemap = null;
        
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            changeBasemap();
        }
        
        function changeBasemap() {
            const selector = document.getElementById('basemapSelector');
            const selectedBasemap = selector ? selector.value : 'osm';
            
            // Remove current basemap
            if (currentBasemap) {
                map.removeLayer(currentBasemap);
            }
            
            // Add new basemap
            switch(selectedBasemap) {
                case 'satellite':
                    currentBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri'
                    });
                    break;
                case 'terrain':
                    currentBasemap = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
                        attribution: 'Map tiles by Stamen Design'
                    });
                    break;
                case 'topo':
                    currentBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri'
                    });
                    break;
                case 'dark':
                    currentBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '© OpenStreetMap contributors © CARTO'
                    });
                    break;
                case 'light':
                    currentBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '© OpenStreetMap contributors © CARTO'
                    });
                    break;
                default: // osm
                    currentBasemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    });
            }
            
            currentBasemap.addTo(map);
        }
        
        // Fit bounds intelligently - show all data but zoom to continental US initially
        function fitBoundsSmartly(layer) {
            const bounds = layer.getBounds();
            
            // Continental US bounds (main viewing area)
            const continentalBounds = L.latLngBounds(
                L.latLng(24.5, -125),  // Southwest corner (includes southern Texas/Florida)
                L.latLng(49.5, -66.5)   // Northeast corner (includes Maine/Washington)
            );
            
            // Extended US bounds (includes Alaska, Hawaii, territories)
            const extendedUSBounds = L.latLngBounds(
                L.latLng(18, -180),    // Southwest corner (includes Hawaii, Caribbean)
                L.latLng(72, -65)      // Northeast corner (includes Alaska)
            );
            
            // Check how much data is in continental vs outside
            let continentalCount = 0;
            let totalCount = 0;
            
            if (currentData && currentData.length > 0) {
                currentData.forEach(feature => {
                    totalCount++;
                    if (feature.geometry && feature.geometry.coordinates) {
                        let lat, lon;
                        // Get a representative point
                        if (feature.geometry.type === 'Point') {
                            [lon, lat] = feature.geometry.coordinates;
                        } else if (feature.geometry.type === 'Polygon') {
                            // Use centroid approximation
                            const coords = feature.geometry.coordinates[0];
                            lon = coords.reduce((sum, p) => sum + p[0], 0) / coords.length;
                            lat = coords.reduce((sum, p) => sum + p[1], 0) / coords.length;
                        } else if (feature.geometry.type === 'MultiPolygon') {
                            // Use first polygon's centroid
                            const coords = feature.geometry.coordinates[0][0];
                            lon = coords.reduce((sum, p) => sum + p[0], 0) / coords.length;
                            lat = coords.reduce((sum, p) => sum + p[1], 0) / coords.length;
                        }
                        
                        // Check if in continental bounds
                        if (lat >= 24.5 && lat <= 49.5 && lon >= -125 && lon <= -66.5) {
                            continentalCount++;
                        }
                    }
                });
            }
            
            // Decision logic:
            // If 90% or more of data is in continental US, zoom to continental
            // If significant data outside (>10%), show wider view
            const continentalRatio = totalCount > 0 ? continentalCount / totalCount : 1;
            
            if (continentalRatio >= 0.9) {
                // Most data is continental - zoom to continental US
                map.fitBounds(continentalBounds, { padding: [20, 20] });
            } else if (continentalRatio >= 0.7) {
                // Some data outside - use slightly expanded view
                const expandedBounds = L.latLngBounds(
                    L.latLng(20, -130),   // Include Hawaii
                    L.latLng(50, -65)     // Include Puerto Rico
                );
                map.fitBounds(expandedBounds, { padding: [20, 20] });
            } else {
                // Significant data outside - fit all data but max out at extended US
                if (bounds && bounds.isValid && bounds.isValid()) {
                    const usConstrainedBounds = bounds.intersect(extendedUSBounds);
                    if (usConstrainedBounds && usConstrainedBounds.isValid()) {
                        map.fitBounds(usConstrainedBounds, { padding: [20, 20] });
                    } else {
                        map.fitBounds(bounds, { padding: [20, 20] });
                    }
                } else {
                    // Fallback to extended US bounds if no valid bounds
                    map.fitBounds(extendedUSBounds, { padding: [20, 20] });
                }
            }
            
            // Log what we're showing
            if (totalCount > 0) {
                console.log(`Showing ${totalCount} features: ${continentalCount} in continental US (${(continentalRatio * 100).toFixed(1)}%), ${totalCount - continentalCount} outside`);
            }
        }

        // Tab switching
        function switchTab(tabName, clickEvent) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Handle both event-based calls and programmatic calls
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            } else {
                // Find and activate the corresponding tab button
                const tabButton = document.querySelector(`.tab[onclick*="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = 'status-message ' + type;
            status.textContent = message;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Show loading
        function showLoading(show = true) {
            document.getElementById('loading').className = show ? 'loading active' : 'loading';
        }

        // Red Cross preset services
        async function loadARCCounties() {
            // ARC County with Demographics layer
            // Uses Layer 5 with enhanced pop-ups and full demographic data
            const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/5';
            await loadArcGISService(url, 'ARC County with Demographics');
        }
        
        async function loadRedCrossDivisions() {
            // Use demographics service for full data, or Master Geography Layer 1 for boundaries
            const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/1';
            // Alternative without demographics:
            // const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/1';
            await loadArcGISService(url, 'ARC Divisions with Demographics');
        }

        async function loadRedCrossChapters() {
            // Use demographics service for full data, or Master Geography Layer 4 for boundaries
            const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/4';
            // Alternative without demographics:
            // const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/4';
            await loadArcGISService(url, 'ARC Chapters with Demographics');
        }

        async function loadRedCrossRegions() {
            // Use demographics service for full data, or Master Geography Layer 2 for boundaries
            const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/2';
            // Alternative without demographics:
            // const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/2';
            await loadArcGISService(url, 'ARC Regions with Demographics');
        }
        
        async function loadARCStates() {
            // Master ARC Geography 2022 - States level (Layer 3 - Master_RC_Geo_States_2025)
            const url = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/3';
            await loadArcGISService(url, 'ARC States (50 US States)');
        }

        // Load custom service
        async function loadCustomService() {
            const url = document.getElementById('customServiceUrl').value.trim();
            if (!url) {
                showStatus('Please enter a service URL', 'error');
                return;
            }
            await loadArcGISService(url, 'Custom Service');
        }

        // Load service by ID
        async function loadServiceById() {
            const serviceId = document.getElementById('serviceId').value.trim();
            const orgSelect = document.getElementById('orgSelect').value;
            
            if (!serviceId) {
                showStatus('Please enter a service ID', 'error');
                return;
            }
            
            let orgId = orgSelect;
            if (orgSelect === 'custom') {
                orgId = document.getElementById('customOrgId').value.trim();
                if (!orgId) {
                    showStatus('Please enter a custom org ID', 'error');
                    return;
                }
            }
            
            const url = `https://services.arcgis.com/${orgId}/arcgis/rest/services/${serviceId}/FeatureServer/0`;
            await loadArcGISService(url, 'Service: ' + serviceId);
        }

        // Parse and load URL
        async function parseAndLoadUrl() {
            const urlText = document.getElementById('directUrl').value.trim();
            if (!urlText) {
                showStatus('Please enter a URL', 'error');
                return;
            }
            
            let serviceUrl = urlText;
            
            // Extract service URL from various formats
            if (urlText.includes('FeatureServer') || urlText.includes('MapServer')) {
                // Already a service URL
                if (!urlText.includes('/0')) {
                    serviceUrl = urlText + '/0';
                }
            } else if (urlText.includes('id=')) {
                // Extract ID from web map URL
                const match = urlText.match(/id=([a-f0-9]{32})/i);
                if (match) {
                    showStatus('Extracted ID: ' + match[1] + ' - Please use the Service by ID section', 'info');
                    document.getElementById('serviceId').value = match[1];
                    switchTab('arcgis');
                    return;
                }
            }
            
            await loadArcGISService(serviceUrl, 'Parsed Service');
        }

        // Main function to load ArcGIS service
        async function loadArcGISService(url, serviceName) {
            showLoading(true);
            showStatus(`Loading ${serviceName}...`, 'info');
            
            try {
                // Ensure proper URL format
                if (!url.includes('?')) {
                    url = url + '?f=json';
                } else if (!url.includes('f=json')) {
                    url = url + '&f=json';
                }
                
                // Fetch service metadata
                const metaResponse = await fetch(url);
                if (!metaResponse.ok) throw new Error('Failed to fetch service metadata');
                const metadata = await metaResponse.json();
                
                // Extract fields
                if (!metadata.fields || metadata.fields.length === 0) {
                    console.warn('No fields in metadata, trying direct query...');
                    // Some services don't return fields in metadata, try direct query
                }
                
                if (metadata.fields && metadata.fields.length > 0) {
                    currentFields = metadata.fields.filter(f => 
                        f.type !== 'esriFieldTypeOID' && 
                        f.type !== 'esriFieldTypeGeometry' &&
                        f.type !== 'esriFieldTypeGlobalID' &&
                        f.name !== 'OBJECTID' &&
                        f.name !== 'Shape' &&
                        f.name !== 'GlobalID'
                    );
                }
                
                // Fetch actual data with geometry
                const dataUrl = url.replace('?f=json', '') + '/query?where=1=1&outFields=*&f=geojson&returnGeometry=true&resultRecordCount=5000';
                const dataResponse = await fetch(dataUrl);
                if (!dataResponse.ok) throw new Error('Failed to fetch service data');
                const geoData = await dataResponse.json();
                
                if (!geoData.features || geoData.features.length === 0) {
                    throw new Error('No features found in service');
                }
                
                currentData = geoData.features;
                currentGeometry = geoData;
                
                // Extract fields from actual data if not from metadata
                if (!currentFields || currentFields.length === 0) {
                    if (geoData.features && geoData.features.length > 0) {
                        const firstFeature = geoData.features[0];
                        currentFields = [];
                        Object.keys(firstFeature.properties).forEach(key => {
                            if (key !== 'OBJECTID' && key !== 'Shape' && key !== 'GlobalID') {
                                currentFields.push({
                                    name: key,
                                    alias: key.replace(/_/g, ' '),
                                    type: typeof firstFeature.properties[key] === 'number' ? 
                                          'esriFieldTypeDouble' : 'esriFieldTypeString'
                                });
                            }
                        });
                    }
                }
                
                // Add calculated unemployment rate if we have both unemployment population and total population
                const hasUnempPop = currentFields.some(f => f.name && f.name.match(/Unemp.*Pop.*SUM/i));
                const hasTotalPop = currentFields.some(f => f.name && f.name.match(/Total.*Pop.*SUM/i));
                
                if (hasUnempPop && hasTotalPop) {
                    const unempField = currentFields.find(f => f.name && f.name.match(/Unemp.*Pop.*SUM/i));
                    const totalField = currentFields.find(f => f.name && f.name.match(/Total.*Pop.*SUM/i));
                    
                    if (unempField && totalField) {
                        console.log(`✅ Adding calculated unemployment rate from ${unempField.name} / ${totalField.name}`);
                        
                        // Add calculated rate to each feature
                        currentData.forEach(feature => {
                            const unempPop = feature.properties[unempField.name];
                            const totalPop = feature.properties[totalField.name];
                            if (unempPop !== null && totalPop !== null && totalPop > 0) {
                                feature.properties['Calculated_Unemp_Rate_2023'] = (unempPop / totalPop) * 100;
                            } else {
                                feature.properties['Calculated_Unemp_Rate_2023'] = null;
                            }
                        });
                        
                        // Add to fields list
                        currentFields.push({
                            name: 'Calculated_Unemp_Rate_2023',
                            alias: 'Calculated Unemployment Rate 2023 (%)',
                            type: 'esriFieldTypeDouble'
                        });
                    }
                }
                
                // Display fields
                displayFields();
                
                // Debug suspicious fields automatically
                if (currentFields.some(f => f.name && f.name.toLowerCase().includes('val'))) {
                    const homeValField = currentFields.find(f => f.name && f.name.toLowerCase().includes('val'));
                    if (homeValField) {
                        console.log('🔍 Debugging home value field:', homeValField.name);
                        debugFieldValues(homeValField.name);
                    }
                }
                
                // Debug unemployment fields
                const unempFields = currentFields.filter(f => f.name && f.name.toLowerCase().includes('unemp'));
                if (unempFields.length > 0) {
                    console.log('🔍 Found unemployment fields:', unempFields.map(f => f.name));
                    unempFields.forEach(field => {
                        console.log(`🔍 Debugging unemployment field: ${field.name}`);
                        debugFieldValues(field.name);
                    });
                }
                
                // Display on map
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }
                
                // Determine color based on service type
                let fillColor = '#B71C1C'; // Default red
                // serviceName already defined
                const serviceLower = serviceName.toLowerCase();
                
                if (serviceLower.includes('count')) {
                    fillColor = '#ff9800'; // Orange for counties
                } else if (serviceLower.includes('division')) {
                    fillColor = '#4CAF50'; // Green for divisions
                } else if (serviceLower.includes('region')) {
                    fillColor = '#9c27b0'; // Purple for regions
                } else if (serviceLower.includes('chapter')) {
                    fillColor = '#2196F3'; // Blue for chapters
                } else if (serviceLower.includes('state')) {
                    fillColor = '#009688'; // Teal for states
                }
                
                currentLayer = L.geoJSON(geoData, {
                    style: {
                        fillColor: fillColor,
                        weight: 1,
                        opacity: 0.7,
                        color: 'white',
                        fillOpacity: 0.3
                    },
                    onEachFeature: function(feature, layer) {
                        // Create rich popup showing key fields
                        const props = feature.properties;
                        let popupContent = buildInitialPopup(props, serviceName || geoType || 'Data');
                        layer.bindPopup(popupContent, { maxWidth: 400 });
                    }
                }).addTo(map);
                
                fitBoundsSmartly(currentLayer);
                
                showStatus(`Loaded ${currentData.length} features from ${serviceName}`, 'success');
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading service:', error);
                showStatus('Error: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Debug function to check data values
        function debugFieldValues(fieldName, sampleSize = 5) {
            console.log(`\n=== DEBUG: Field ${fieldName} ===`);
            const samples = currentData.slice(0, sampleSize);
            samples.forEach((feature, i) => {
                const value = feature.properties[fieldName];
                console.log(`Sample ${i+1}:`, typeof value, value);
            });
        }

        // Display fields
        function displayFields() {
            const fieldSection = document.getElementById('fieldSelection');
            const arcgisVariableSection = document.getElementById('arcgisVariableSelection');
            const fieldList = document.getElementById('fieldList');
            const fieldCount = document.getElementById('fieldCount');
            const xSelect = document.getElementById('xVariable');
            const ySelect = document.getElementById('yVariable');
            const arcgisXSelect = document.getElementById('arcgisXVariable');
            const arcgisYSelect = document.getElementById('arcgisYVariable');
            
            // Only show the variable selection sections, not the redundant field list
            arcgisVariableSection.style.display = 'block';
            // fieldSection.style.display = 'block';  // This is redundant - fields show in dropdowns
            fieldCount.textContent = `Found ${currentFields.length} data fields`;
            
            // Clear previous options
            xSelect.innerHTML = '<option value="">-- Select X Variable --</option>';
            ySelect.innerHTML = '<option value="">-- Select Y Variable --</option>';
            arcgisXSelect.innerHTML = '<option value="">-- Select X Variable --</option>';
            arcgisYSelect.innerHTML = '<option value="">-- Select Y Variable --</option>';
            fieldList.innerHTML = '';
            
            // Add fields to selects and list
            currentFields.forEach(field => {
                const fieldName = field.name || field.fieldName;
                const fieldAlias = field.alias || fieldName;
                const fieldType = field.type || 'Unknown';
                
                // Add to selects (all fields that contain numeric data)
                let isNumeric = false;
                
                // Check field type first
                if (fieldType.includes('Integer') || fieldType.includes('Double') || fieldType.includes('Single') || fieldType.includes('Number')) {
                    isNumeric = true;
                } else {
                    // For string fields, check if they actually contain numeric data
                    // Sample multiple values to be sure
                    let numericCount = 0;
                    const sampleSize = Math.min(5, currentData.length);
                    
                    for (let i = 0; i < sampleSize; i++) {
                        const value = currentData[i]?.properties[fieldName];
                        if (value !== null && value !== undefined && value !== '') {
                            const num = parseFloat(value);
                            if (!isNaN(num) && isFinite(num)) {
                                numericCount++;
                            }
                        }
                    }
                    
                    // If most samples are numeric, treat as numeric field
                    isNumeric = numericCount >= Math.ceil(sampleSize * 0.6);
                }
                                 
                // Filter out problematic fields and technical metadata users don't need
                const isProblemField = ((fieldName.toLowerCase().includes('unemp') && fieldName.includes('WAVG')) ||
                                     fieldName === 'Unemp_Rate_2023_WAVG' ||
                                     fieldName === 'Unemp_Rate_2023_CALC' ||
                                     fieldName === 'Avg_Home_Val_2023_WAVG' ||
                                     fieldName.toLowerCase().includes('avg_') ||
                                     fieldName.toLowerCase().includes('average') ||
                                     (fieldName.includes('WAVG') && fieldName.toLowerCase().includes('val')) ||
                                     (fieldName.includes('CALC') && fieldName.toLowerCase().includes('rate')) ||
                                     // Technical geographic fields users don't need
                                     fieldName.toLowerCase().includes('shape') ||
                                     fieldName.toLowerCase().includes('area') ||
                                     fieldName.toLowerCase().includes('length') ||
                                     fieldName.toLowerCase().includes('acres') ||
                                     fieldName.toLowerCase().includes('sqmi') ||
                                     fieldName.toLowerCase().includes('sq_mi') ||
                                     // Division codes and technical IDs
                                     fieldName.toLowerCase().includes('div_code') ||
                                     fieldName.toLowerCase().includes('division_code')) &&
                                     fieldName !== 'Calculated_Unemp_Rate_2023'; // Allow our calculated rate
                
                if (isNumeric && fieldName !== 'OBJECTID' && fieldName !== 'GlobalID' && fieldName !== 'Shape' && !isProblemField) {
                    const xOption = document.createElement('option');
                    xOption.value = fieldName;
                    xOption.textContent = fieldAlias;
                    xSelect.appendChild(xOption);
                    
                    const yOption = document.createElement('option');
                    yOption.value = fieldName;
                    yOption.textContent = fieldAlias;
                    ySelect.appendChild(yOption);
                    
                    // Also add to ArcGIS dropdowns
                    const arcgisXOption = document.createElement('option');
                    arcgisXOption.value = fieldName;
                    arcgisXOption.textContent = fieldAlias;
                    arcgisXSelect.appendChild(arcgisXOption);
                    
                    const arcgisYOption = document.createElement('option');
                    arcgisYOption.value = fieldName;
                    arcgisYOption.textContent = fieldAlias;
                    arcgisYSelect.appendChild(arcgisYOption);
                }
                
                // Add to field list (skip problem fields)
                if (!isProblemField) {
                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'field-item';
                    fieldItem.innerHTML = `
                        <strong>${fieldAlias}</strong>
                        <span style="float: right; color: #666; font-size: 11px;">${fieldType.replace('esriFieldType', '')}</span>
                    `;
                    fieldList.appendChild(fieldItem);
                }
            });
        }

        // Generate bivariate map
        async function generateBivariateMap() {
            // Check both sets of dropdowns (Manual tab and ArcGIS tab)
            let xVar = document.getElementById('xVariable').value;
            let yVar = document.getElementById('yVariable').value;
            
            // If ArcGIS dropdowns have values, use those instead
            const arcgisXVar = document.getElementById('arcgisXVariable').value;
            const arcgisYVar = document.getElementById('arcgisYVariable').value;
            
            if (arcgisXVar) xVar = arcgisXVar;
            if (arcgisYVar) yVar = arcgisYVar;
            
            if (!xVar || !yVar) {
                showStatus('Please select both X and Y variables', 'error');
                return;
            }
            
            if (xVar === yVar) {
                showStatus('Please select different variables for X and Y', 'error');
                return;
            }
            
            showLoading(true);
            showStatus('Generating bivariate map...', 'info');
            
            try {
                // Extract values for selected variables
                const xValues = [];
                const yValues = [];
                
                currentData.forEach(feature => {
                    const xVal = parseFloat(feature.properties[xVar]);
                    const yVal = parseFloat(feature.properties[yVar]);
                    
                    if (!isNaN(xVal) && !isNaN(yVal)) {
                        xValues.push(xVal);
                        yValues.push(yVal);
                    }
                });
                
                if (xValues.length === 0) {
                    throw new Error('No valid numeric data found for selected variables');
                }
                
                // Calculate quantiles
                xValues.sort((a, b) => a - b);
                yValues.sort((a, b) => a - b);
                
                const xQuantiles = [
                    xValues[Math.floor(xValues.length * 0.33)],
                    xValues[Math.floor(xValues.length * 0.67)]
                ];
                
                const yQuantiles = [
                    yValues[Math.floor(yValues.length * 0.33)],
                    yValues[Math.floor(yValues.length * 0.67)]
                ];
                
                // Calculate correlation
                const correlation = calculateCorrelation(xValues, yValues);
                
                // Initialize quadrant counts
                let highHigh = 0, highLow = 0, lowHigh = 0, lowLow = 0;
                
                // Apply bivariate colors
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }
                
                currentLayer = L.geoJSON(currentGeometry, {
                    style: function(feature) {
                        const xVal = parseFloat(feature.properties[xVar]);
                        const yVal = parseFloat(feature.properties[yVar]);
                        
                        if (isNaN(xVal) || isNaN(yVal)) {
                            return {
                                fillColor: '#cccccc',
                                weight: 0.5,
                                opacity: 0.7,
                                color: 'white',
                                fillOpacity: 0.7
                            };
                        }
                        
                        // Determine quantile positions
                        let xPos = xVal <= xQuantiles[0] ? 0 : xVal <= xQuantiles[1] ? 1 : 2;
                        let yPos = yVal <= yQuantiles[0] ? 0 : yVal <= yQuantiles[1] ? 1 : 2;
                        
                        // Update quadrant counts
                        if (xPos === 2 && yPos === 2) highHigh++;
                        else if (xPos === 2 && yPos === 0) highLow++;
                        else if (xPos === 0 && yPos === 2) lowHigh++;
                        else if (xPos === 0 && yPos === 0) lowLow++;
                        
                        const color = getBivariateColor(xPos / 2, yPos / 2);
                        
                        return {
                            fillColor: color,
                            weight: 0.5,
                            opacity: 0.7,
                            color: 'white',
                            fillOpacity: 0.8
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        // Get original values, not parsed
                        const xVal = props[xVar];
                        const yVal = props[yVar];
                        
                        // Build enhanced popup with original values
                        let popupContent = buildEnhancedPopup(props, xVar, yVar, xVal, yVal);
                        layer.bindPopup(popupContent, { maxWidth: 400 });
                    }
                }).addTo(map);
                
                // Auto-zoom to data extent using smart bounds
                fitBoundsSmartly(currentLayer);
                
                // Update legend
                updateLegend(xVar, yVar);
                
                // Update statistics
                document.getElementById('correlationValue').textContent = correlation.toFixed(3);
                document.getElementById('featureCount').textContent = currentData.length;
                document.getElementById('highHighCount').textContent = highHigh;
                document.getElementById('highLowCount').textContent = highLow;
                document.getElementById('lowHighCount').textContent = lowHigh;
                document.getElementById('lowLowCount').textContent = lowLow;
                
                // Update correlation indicator
                const indicator = document.getElementById('correlationIndicator');
                const position = ((correlation + 1) / 2) * 100;
                indicator.style.left = `calc(${position}% - 20px)`;
                indicator.textContent = correlation.toFixed(2);
                
                // Show stats and export sections
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('exportSection').style.display = 'block';
                
                showStatus('Bivariate map generated successfully', 'success');
                showLoading(false);
                
            } catch (error) {
                console.error('Error generating map:', error);
                showStatus('Error: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Bivariate color function with smooth interpolation
        function getBivariateColor(x, y) {
            // Corner colors for bivariate scheme
            const bottomLeft = {r: 232, g: 232, b: 232};  // Light gray
            const bottomRight = {r: 200, g: 184, b: 214}; // Light purple
            const topLeft = {r: 115, g: 174, b: 128};     // Green
            const topRight = {r: 90, g: 90, b: 139};      // Dark purple
            
            // Bilinear interpolation
            const bottom = {
                r: bottomLeft.r + (bottomRight.r - bottomLeft.r) * x,
                g: bottomLeft.g + (bottomRight.g - bottomLeft.g) * x,
                b: bottomLeft.b + (bottomRight.b - bottomLeft.b) * x
            };
            
            const top = {
                r: topLeft.r + (topRight.r - topLeft.r) * x,
                g: topLeft.g + (topRight.g - topLeft.g) * x,
                b: topLeft.b + (topRight.b - topLeft.b) * x
            };
            
            const final = {
                r: Math.round(bottom.r + (top.r - bottom.r) * y),
                g: Math.round(bottom.g + (top.g - bottom.g) * y),
                b: Math.round(bottom.b + (top.b - bottom.b) * y)
            };
            
            return `rgb(${final.r}, ${final.g}, ${final.b})`;
        }

        // Update legend
        function updateLegend(xVar, yVar) {
            const legendSection = document.getElementById('legendSection');
            const legendGrid = document.getElementById('legendGrid');
            
            legendSection.style.display = 'block';
            legendGrid.innerHTML = '';
            
            // Create 3x3 grid
            for (let y = 2; y >= 0; y--) {
                for (let x = 0; x <= 2; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'legend-cell';
                    cell.style.backgroundColor = getBivariateColor(x / 2, y / 2);
                    
                    // Add labels to corner cells
                    if (x === 0 && y === 0) cell.textContent = 'L-L';
                    else if (x === 2 && y === 0) cell.textContent = 'H-L';
                    else if (x === 0 && y === 2) cell.textContent = 'L-H';
                    else if (x === 2 && y === 2) cell.textContent = 'H-H';
                    
                    legendGrid.appendChild(cell);
                }
            }
            
            document.getElementById('xLabel').textContent = `→ ${xVar}`;
            document.getElementById('yLabel').textContent = `↑ ${yVar}`;
        }

        // Calculate correlation
        function calculateCorrelation(xValues, yValues) {
            const n = xValues.length;
            const xMean = xValues.reduce((a, b) => a + b, 0) / n;
            const yMean = yValues.reduce((a, b) => a + b, 0) / n;
            
            let numerator = 0;
            let xDenominator = 0;
            let yDenominator = 0;
            
            for (let i = 0; i < n; i++) {
                const xDiff = xValues[i] - xMean;
                const yDiff = yValues[i] - yMean;
                numerator += xDiff * yDiff;
                xDenominator += xDiff * xDiff;
                yDenominator += yDiff * yDiff;
            }
            
            return numerator / Math.sqrt(xDenominator * yDenominator);
        }

        // Export functions
        function exportData(format) {
            if (!currentData || currentData.length === 0) {
                showStatus('No data to export', 'error');
                return;
            }
            
            const xVar = document.getElementById('xVariable').value;
            const yVar = document.getElementById('yVariable').value;
            
            if (format === 'csv') {
                let csv = 'Name,' + xVar + ',' + yVar + '\n';
                currentData.forEach(feature => {
                    const name = feature.properties.NAME || feature.properties.County || 'Unknown';
                    const xVal = feature.properties[xVar] || '';
                    const yVal = feature.properties[yVar] || '';
                    csv += `"${name}",${xVal},${yVal}\n`;
                });
                
                downloadFile(csv, 'bivariate_data.csv', 'text/csv');
                showStatus('CSV exported successfully', 'success');
            } else if (format === 'geojson') {
                const geojson = JSON.stringify(currentGeometry, null, 2);
                downloadFile(geojson, 'bivariate_map.geojson', 'application/json');
                showStatus('GeoJSON exported successfully', 'success');
            } else if (format === 'image') {
                // This would require additional library like leaflet-image
                showStatus('Image export requires additional setup', 'info');
            }
        }

        // Download file helper
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Handle org select change
        document.getElementById('orgSelect').addEventListener('change', function(e) {
            const customOrgInput = document.getElementById('customOrgId');
            if (e.target.value === 'custom') {
                customOrgInput.style.display = 'block';
            } else {
                customOrgInput.style.display = 'none';
            }
        });

        // CSV file upload handler
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showLoading(true);
            showStatus('Processing CSV file...', 'info');
            
            try {
                const text = await file.text();
                const parsed = Papa.parse(text, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });
                
                if (!parsed.data || parsed.data.length === 0) {
                    throw new Error('No data found in CSV');
                }
                
                // Store CSV data separately
                csvData = parsed.data;
                csvFields = Object.keys(parsed.data[0]);
                
                // Update CSV match field dropdown
                const csvMatchField = document.getElementById('csvMatchField');
                csvMatchField.innerHTML = '<option value="">-- Select CSV field to match --</option>';
                csvFields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    csvMatchField.appendChild(option);
                });
                
                document.getElementById('csvFieldMapping').style.display = 'block';
                
                showStatus(`Loaded ${parsed.data.length} rows with ${csvFields.length} fields from CSV`, 'success');
                showLoading(false);
                
                showStatus('Please select a geography type to match your data', 'info');
                
            } catch (error) {
                console.error('Error processing CSV:', error);
                showStatus('Error: ' + error.message, 'error');
                showLoading(false);
            }
        });
        
        // Handle geography selection change
        function handleGeographyChange() {
            const geoType = document.getElementById('geographyType').value;
            const matchHelp = document.getElementById('matchHelp');
            const geoMatchField = document.getElementById('geoMatchField');
            
            if (!geoType) {
                matchHelp.style.display = 'none';
                return;
            }
            
            matchHelp.style.display = 'block';
            geoMatchField.innerHTML = '<option value="">-- Select geography field --</option>';
            
            switch(geoType) {
                case 'arc_counties':
                    matchHelp.textContent = 'Your CSV should contain FIPS codes or County names (3,142 US counties)';
                    geoMatchField.innerHTML += '<option value="FIPS">FIPS Code</option>';
                    geoMatchField.innerHTML += '<option value="County">County Name</option>';
                    geoMatchField.innerHTML += '<option value="County_ST">County, State</option>';
                    geoMatchField.innerHTML += '<option value="GeoID">Geo ID</option>';
                    break;
                case 'divisions':
                    matchHelp.textContent = 'Your CSV should contain Division names (7 ARC divisions)';
                    geoMatchField.innerHTML += '<option value="Division">Division Name</option>';
                    geoMatchField.innerHTML += '<option value="Division_ID">Division ID</option>';
                    geoMatchField.innerHTML += '<option value="Division_Code">Division Code</option>';
                    break;
                case 'chapters':
                    matchHelp.textContent = 'Your CSV should contain Chapter names (250+ ARC chapters)';
                    geoMatchField.innerHTML += '<option value="Chapter">Chapter Name</option>';
                    geoMatchField.innerHTML += '<option value="Chapter_Code">Chapter Code</option>';
                    geoMatchField.innerHTML += '<option value="Chapter_ID">Chapter ID</option>';
                    break;
                case 'regions':
                    matchHelp.textContent = 'Your CSV should contain Region names (59 ARC regions)';
                    geoMatchField.innerHTML += '<option value="Region">Region Name</option>';
                    geoMatchField.innerHTML += '<option value="Region_Code">Region Code</option>';
                    geoMatchField.innerHTML += '<option value="Region_ID">Region ID</option>';
                    break;
                case 'states':
                    matchHelp.textContent = 'Your CSV should contain State names or abbreviations';
                    geoMatchField.innerHTML += '<option value="State">State Name</option>';
                    geoMatchField.innerHTML += '<option value="STATE_ABBR">State Abbreviation</option>';
                    break;
            }
        }
        
        // Match and merge CSV data with geography
        async function matchAndMergeData() {
            const geoType = document.getElementById('geographyType').value;
            const csvMatchField = document.getElementById('csvMatchField').value;
            const geoMatchField = document.getElementById('geoMatchField').value;
            
            if (!geoType || !csvMatchField || !geoMatchField) {
                showStatus('Please select all matching fields', 'error');
                return;
            }
            
            if (!csvData) {
                showStatus('Please upload CSV data first', 'error');
                return;
            }
            
            showLoading(true);
            showStatus('Loading geography and matching data...', 'info');
            
            try {
                // Load the appropriate geography
                let serviceUrl;
                switch(geoType) {
                    case 'arc_counties':
                        // Master ARC Geography 2022 - County layer (Layer 5)
                        serviceUrl = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/5';
                        break;
                    case 'divisions':
                        serviceUrl = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/1';
                        break;
                    case 'chapters':
                        serviceUrl = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/4';
                        break;
                    case 'regions':
                        serviceUrl = 'https://services.arcgis.com/pGfbNJoYypmNq86F/arcgis/rest/services/Master_ARC_Geography_2022/FeatureServer/2';
                        break;
                    default:
                        throw new Error('Geography type not supported');
                }
                
                // Build a WHERE clause to only fetch matching features
                let whereClause = '1=1';  // Default to all features
                
                // For FIPS matching with counties, build a specific query
                if (geoMatchField === 'FIPS' && csvMatchField === 'FIPS') {
                    const fipsValues = csvData.map(row => `'${row[csvMatchField]}'`).join(',');
                    whereClause = `FIPS IN (${fipsValues})`;
                } else if (geoMatchField === 'County' && csvMatchField === 'County') {
                    const countyValues = csvData.map(row => `'${row[csvMatchField]}'`).join(',');
                    whereClause = `County IN (${countyValues})`;
                }
                
                // Fetch geography data with filter
                const dataUrl = serviceUrl + '/query?where=' + encodeURIComponent(whereClause) + '&outFields=*&f=geojson&returnGeometry=true&resultRecordCount=5000';
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error('Failed to fetch geography');
                const geoData = await response.json();
                
                // Check if we got features
                if (!geoData.features || geoData.features.length === 0) {
                    throw new Error('No geographic features found. Try selecting a different geography type.');
                }
                
                // Match and merge data
                let matchedCount = 0;
                let unmatchedCSV = [];
                
                geoData.features.forEach(feature => {
                    const geoValue = feature.properties[geoMatchField];
                    
                    // Find matching CSV row
                    const csvMatch = csvData.find(row => {
                        const csvValue = row[csvMatchField];
                        
                        // Handle different matching scenarios
                        if (typeof csvValue === 'string' && typeof geoValue === 'string') {
                            // Remove 'County' suffix for better matching
                            const csvClean = csvValue.replace(/ County$/i, '').toLowerCase().trim();
                            const geoClean = geoValue.replace(/ County$/i, '').toLowerCase().trim();
                            
                            // Try exact match first
                            if (csvClean === geoClean) return true;
                            
                            // Try with County added/removed
                            if (csvValue.toLowerCase().trim() === geoValue.toLowerCase().trim()) return true;
                            
                            // Try partial match
                            if (geoClean.includes(csvClean) || csvClean.includes(geoClean)) return true;
                        }
                        
                        // Try numeric match (for FIPS codes)
                        if (typeof csvValue === 'number' && typeof geoValue === 'number') {
                            return csvValue === geoValue;
                        }
                        
                        // Try string to number match
                        return String(csvValue) === String(geoValue);
                    });
                    
                    if (csvMatch) {
                        // Merge CSV data into feature properties
                        Object.keys(csvMatch).forEach(key => {
                            if (key !== csvMatchField) {
                                feature.properties['CSV_' + key] = csvMatch[key];
                            }
                        });
                        matchedCount++;
                    }
                });
                
                // Check for unmatched CSV rows
                csvData.forEach(row => {
                    const csvValue = row[csvMatchField];
                    const found = geoData.features.some(f => {
                        const geoValue = f.properties[geoMatchField];
                        
                        if (typeof csvValue === 'string' && typeof geoValue === 'string') {
                            const csvClean = csvValue.replace(/ County$/i, '').toLowerCase().trim();
                            const geoClean = geoValue.replace(/ County$/i, '').toLowerCase().trim();
                            
                            return csvClean === geoClean || 
                                   csvValue.toLowerCase().trim() === geoValue.toLowerCase().trim() ||
                                   geoClean.includes(csvClean) || 
                                   csvClean.includes(geoClean);
                        }
                        return String(csvValue) === String(geoValue);
                    });
                    if (!found) {
                        unmatchedCSV.push(csvValue);
                    }
                });
                
                // Update current data
                currentData = geoData.features;
                currentGeometry = geoData;
                
                // Update fields to include CSV fields
                const mergedFields = [];
                
                // Add original geo fields
                const firstFeature = geoData.features[0];
                Object.keys(firstFeature.properties).forEach(key => {
                    if (!key.startsWith('CSV_')) {
                        mergedFields.push({
                            name: key,
                            alias: key.replace(/_/g, ' '),
                            type: typeof firstFeature.properties[key] === 'number' ? 'esriFieldTypeDouble' : 'esriFieldTypeString'
                        });
                    }
                });
                
                // Add CSV fields
                csvFields.forEach(field => {
                    if (field !== csvMatchField) {
                        mergedFields.push({
                            name: 'CSV_' + field,
                            alias: field.replace(/_/g, ' ') + ' (CSV)',
                            type: typeof csvData[0][field] === 'number' ? 'esriFieldTypeDouble' : 'esriFieldTypeString'
                        });
                    }
                });
                
                currentFields = mergedFields;
                displayFields();
                
                // Display on map
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }
                
                // Determine color based on service type
                let fillColor = '#B71C1C'; // Default red
                const serviceName = geoType || 'data';
                const serviceLower = serviceName.toLowerCase();
                
                if (serviceLower.includes('count')) {
                    fillColor = '#ff9800'; // Orange for counties
                } else if (serviceLower.includes('division')) {
                    fillColor = '#4CAF50'; // Green for divisions
                } else if (serviceLower.includes('region')) {
                    fillColor = '#9c27b0'; // Purple for regions
                } else if (serviceLower.includes('chapter')) {
                    fillColor = '#2196F3'; // Blue for chapters
                } else if (serviceLower.includes('state')) {
                    fillColor = '#009688'; // Teal for states
                }
                
                currentLayer = L.geoJSON(geoData, {
                    style: {
                        fillColor: fillColor,
                        weight: 1,
                        opacity: 0.7,
                        color: 'white',
                        fillOpacity: 0.3
                    },
                    onEachFeature: function(feature, layer) {
                        // Create rich popup showing key fields
                        const props = feature.properties;
                        let popupContent = buildInitialPopup(props, serviceName || geoType || 'Data');
                        layer.bindPopup(popupContent, { maxWidth: 400 });
                    }
                }).addTo(map);
                
                fitBoundsSmartly(currentLayer);
                
                // Show results
                let statusMsg = `Successfully matched ${matchedCount} of ${csvData.length} CSV rows to ${geoData.features.length} geographic features`;
                if (unmatchedCSV.length > 0) {
                    statusMsg += `. Unmatched CSV values: ${unmatchedCSV.slice(0, 5).join(', ')}${unmatchedCSV.length > 5 ? '...' : ''}`;
                }
                
                showStatus(statusMsg, matchedCount > 0 ? 'success' : 'error');
                showLoading(false);
                
                // If this is Florida ALICE data, auto-select good variables
                if (csvData && csvData[0] && csvData[0].hasOwnProperty('ALICE Households')) {
                    setTimeout(() => {
                        const xSelect = document.getElementById('xVariable');
                        const ySelect = document.getElementById('yVariable');
                        
                        // Find ALICE percentage field
                        for (let i = 0; i < xSelect.options.length; i++) {
                            if (xSelect.options[i].text.includes('Vulnerable_Percent')) {
                                xSelect.selectedIndex = i;
                                break;
                            }
                        }
                        
                        // Find median income field
                        for (let i = 0; i < ySelect.options.length; i++) {
                            if (ySelect.options[i].text.includes('Med_HH_Inc')) {
                                ySelect.selectedIndex = i;
                                break;
                            }
                        }
                        
                        // Highlight generate button
                        const genBtn = document.querySelector('button[onclick="generateBivariateMap()"]');
                        if (genBtn) {
                            genBtn.style.animation = 'pulse 2s infinite';
                            genBtn.style.background = 'linear-gradient(135deg, #9c27b0, #7b1fa2)';
                            genBtn.innerHTML = '⭐ FINAL STEP - Generate Your Map!';
                        }
                        
                        showStatus('Variables selected! Click "FINAL STEP" to generate your bivariate map!', 'success');
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error matching data:', error);
                showStatus('Error: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Reset functions for each tab
        function resetArcGISTab() {
            document.getElementById('customServiceUrl').value = '';
            document.getElementById('serviceId').value = '';
            document.getElementById('orgSelect').value = '8DAUcrpQcpyLMznu';
            document.getElementById('customOrgId').value = '';
            document.getElementById('customOrgId').style.display = 'none';
            showStatus('ArcGIS tab reset', 'info');
        }
        
        function resetCSVTab() {
            document.getElementById('csvFile').value = '';
            document.getElementById('geographyType').value = '';
            document.getElementById('csvMatchField').innerHTML = '<option value="">-- Select CSV field to match --</option>';
            document.getElementById('geoMatchField').innerHTML = '<option value="">-- Select geography field --</option>';
            document.getElementById('csvFieldMapping').style.display = 'none';
            document.getElementById('matchHelp').style.display = 'none';
            csvData = null;
            csvFields = [];
            showStatus('CSV tab reset', 'info');
        }
        
        function resetManualTab() {
            document.getElementById('directUrl').value = '';
            showStatus('Manual tab reset', 'info');
        }
        
        function resetFieldSelection() {
            document.getElementById('xVariable').value = '';
            document.getElementById('yVariable').value = '';
            showStatus('Field selection cleared', 'info');
        }
        
        function resetAll() {
            // Reset all tabs
            resetArcGISTab();
            resetCSVTab();
            resetManualTab();
            resetFieldSelection();
            
            // Clear map
            if (currentLayer) {
                map.removeLayer(currentLayer);
                currentLayer = null;
            }
            
            // Reset data
            currentData = [];
            currentFields = [];
            currentGeometry = null;
            csvData = null;
            csvFields = [];
            
            // Hide sections  
            document.getElementById('arcgisVariableSelection').style.display = 'none';
            // No longer showing fieldSelection section - it's redundant
            document.getElementById('legendSection').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            
            // Reset map view
            map.setView([39.8283, -98.5795], 4);
            
            showStatus('Application reset complete', 'success');
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + R to reset all
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                resetAll();
            }
        });
        
        // One-click Florida ALICE Demo
        async function runFloridaALICEOneClick() {
            showStatus('✨ Starting automated Florida ALICE analysis...', 'info');
            
            // Step 1: Load ALICE data
            loadFloridaALICEData();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Step 2: Match data
            showStatus('Step 2: Matching to 67 Florida counties...', 'info');
            matchAndMergeData();
            
            // Wait for matching to complete (check for field selection to appear)
            let matchingComplete = false;
            for (let i = 0; i < 30; i++) { // Wait up to 30 seconds
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (document.getElementById('arcgisVariableSelection').style.display === 'block') {
                    matchingComplete = true;
                    break;
                }
            }
            
            if (!matchingComplete) {
                showStatus('Matching is taking longer than expected. Please try manually.', 'error');
                return;
            }
            
            // Wait a bit more for auto-selection to happen
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Step 3: Generate map
            showStatus('🎨 Step 3: Creating bivariate map...', 'info');
            generateBivariateMap();
            
            // Wait for map generation
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Check if map was generated
            if (document.getElementById('legendSection').style.display === 'block') {
                showStatus('Complete! Florida ALICE map ready. Purple areas = high vulnerability + high income!', 'success');
            } else {
                showStatus('✨ Processing complete. Click "Generate Bivariate Map" if needed.', 'info');
            }
        }
        
        // Load Florida ALICE data
        function loadFloridaALICEData() {
            // Real 2023 Florida County ALICE Data - with correct values from CSV
            const floridaALICEData = [
                { County: 'Alachua', FIPS: '12001', Households: 121753, 'Poverty Households': 23285, 'ALICE Households': 34206, 'Above ALICE Households': 64262, 'ALICE Threshold - HH under 65': 57643, 'ALICE Threshold - HH 65 years and over': 57924 },
                { County: 'Baker', FIPS: '12003', Households: 9012, 'Poverty Households': 1146, 'ALICE Households': 2530, 'Above ALICE Households': 5336, 'ALICE Threshold - HH under 65': 64582, 'ALICE Threshold - HH 65 years and over': 50868 },
                { County: 'Bay', FIPS: '12005', Households: 80689, 'Poverty Households': 10178, 'ALICE Households': 22772, 'Above ALICE Households': 47739, 'ALICE Threshold - HH under 65': 60522, 'ALICE Threshold - HH 65 years and over': 60048 },
                { County: 'Bradford', FIPS: '12007', Households: 9104, 'Poverty Households': 2016, 'ALICE Households': 2664, 'Above ALICE Households': 4424, 'ALICE Threshold - HH under 65': 63503, 'ALICE Threshold - HH 65 years and over': 51636 },
                { County: 'Brevard', FIPS: '12009', Households: 258656, 'Poverty Households': 25275, 'ALICE Households': 82832, 'Above ALICE Households': 150549, 'ALICE Threshold - HH under 65': 69744, 'ALICE Threshold - HH 65 years and over': 59904 },
                { County: 'Broward', FIPS: '12011', Households: 758853, 'Poverty Households': 102269, 'ALICE Households': 277598, 'Above ALICE Households': 378986, 'ALICE Threshold - HH under 65': 77114, 'ALICE Threshold - HH 65 years and over': 67824 },
                { County: 'Calhoun', FIPS: '12013', Households: 4625, 'Poverty Households': 997, 'ALICE Households': 1645, 'Above ALICE Households': 1983, 'ALICE Threshold - HH under 65': 59675, 'ALICE Threshold - HH 65 years and over': 50604 },
                { County: 'Charlotte', FIPS: '12015', Households: 90367, 'Poverty Households': 7901, 'ALICE Households': 30431, 'Above ALICE Households': 52035, 'ALICE Threshold - HH under 65': 67040, 'ALICE Threshold - HH 65 years and over': 57780 },
                { County: 'Citrus', FIPS: '12017', Households: 75745, 'Poverty Households': 13884, 'ALICE Households': 24368, 'Above ALICE Households': 37493, 'ALICE Threshold - HH under 65': 56130, 'ALICE Threshold - HH 65 years and over': 52296 },
                { County: 'Clay', FIPS: '12019', Households: 86946, 'Poverty Households': 7385, 'ALICE Households': 27728, 'Above ALICE Households': 51833, 'ALICE Threshold - HH under 65': 69884, 'ALICE Threshold - HH 65 years and over': 60468 },
                { County: 'Collier', FIPS: '12021', Households: 166192, 'Poverty Households': 16267, 'ALICE Households': 54932, 'Above ALICE Households': 94993, 'ALICE Threshold - HH under 65': 81812, 'ALICE Threshold - HH 65 years and over': 67716 },
                { County: 'Columbia', FIPS: '12023', Households: 26720, 'Poverty Households': 4411, 'ALICE Households': 9482, 'Above ALICE Households': 12827, 'ALICE Threshold - HH under 65': 61980, 'ALICE Threshold - HH 65 years and over': 50496 },
                { County: 'DeSoto', FIPS: '12027', Households: 12656, 'Poverty Households': 2419, 'ALICE Households': 5026, 'Above ALICE Households': 5211, 'ALICE Threshold - HH under 65': 65002, 'ALICE Threshold - HH 65 years and over': 52176 },
                { County: 'Dixie', FIPS: '12029', Households: 6130, 'Poverty Households': 1098, 'ALICE Households': 2523, 'Above ALICE Households': 2509, 'ALICE Threshold - HH under 65': 60968, 'ALICE Threshold - HH 65 years and over': 51108 },
                { County: 'Duval', FIPS: '12031', Households: 428020, 'Poverty Households': 61768, 'ALICE Households': 118775, 'Above ALICE Households': 247477, 'ALICE Threshold - HH under 65': 59071, 'ALICE Threshold - HH 65 years and over': 59184 },
                { County: 'Escambia', FIPS: '12033', Households: 131375, 'Poverty Households': 16021, 'ALICE Households': 36362, 'Above ALICE Households': 78992, 'ALICE Threshold - HH under 65': 60320, 'ALICE Threshold - HH 65 years and over': 56856 },
                { County: 'Flagler', FIPS: '12035', Households: 56177, 'Poverty Households': 5078, 'ALICE Households': 20470, 'Above ALICE Households': 30629, 'ALICE Threshold - HH under 65': 70332, 'ALICE Threshold - HH 65 years and over': 59580 },
                { County: 'Franklin', FIPS: '12037', Households: 4918, 'Poverty Households': 809, 'ALICE Households': 1395, 'Above ALICE Households': 2714, 'ALICE Threshold - HH under 65': 61484, 'ALICE Threshold - HH 65 years and over': 51528 },
                { County: 'Gadsden', FIPS: '12039', Households: 16485, 'Poverty Households': 3810, 'ALICE Households': 6598, 'Above ALICE Households': 6077, 'ALICE Threshold - HH under 65': 65155, 'ALICE Threshold - HH 65 years and over': 54432 },
                { County: 'Gilchrist', FIPS: '12041', Households: 6913, 'Poverty Households': 964, 'ALICE Households': 2481, 'Above ALICE Households': 3468, 'ALICE Threshold - HH under 65': 64327, 'ALICE Threshold - HH 65 years and over': 54456 },
                { County: 'Glades', FIPS: '12043', Households: 4560, 'Poverty Households': 1038, 'ALICE Households': 1885, 'Above ALICE Households': 1637, 'ALICE Threshold - HH under 65': 64328, 'ALICE Threshold - HH 65 years and over': 52032 },
                { County: 'Gulf', FIPS: '12045', Households: 5800, 'Poverty Households': 736, 'ALICE Households': 1960, 'Above ALICE Households': 3104, 'ALICE Threshold - HH under 65': 64916, 'ALICE Threshold - HH 65 years and over': 56028 },
                { County: 'Hamilton', FIPS: '12047', Households: 4360, 'Poverty Households': 1130, 'ALICE Households': 1264, 'Above ALICE Households': 1966, 'ALICE Threshold - HH under 65': 53825, 'ALICE Threshold - HH 65 years and over': 49188 },
                { County: 'Hardee', FIPS: '12049', Households: 8148, 'Poverty Households': 2078, 'ALICE Households': 2263, 'Above ALICE Households': 3807, 'ALICE Threshold - HH under 65': 62225, 'ALICE Threshold - HH 65 years and over': 49908 },
                { County: 'Hendry', FIPS: '12051', Households: 13944, 'Poverty Households': 2556, 'ALICE Households': 5038, 'Above ALICE Households': 6350, 'ALICE Threshold - HH under 65': 61963, 'ALICE Threshold - HH 65 years and over': 50904 },
                { County: 'Hernando', FIPS: '12053', Households: 85911, 'Poverty Households': 10294, 'ALICE Households': 35610, 'Above ALICE Households': 40007, 'ALICE Threshold - HH under 65': 73223, 'ALICE Threshold - HH 65 years and over': 63588 },
                { County: 'Highlands', FIPS: '12055', Households: 47278, 'Poverty Households': 9609, 'ALICE Households': 15511, 'Above ALICE Households': 22158, 'ALICE Threshold - HH under 65': 59588, 'ALICE Threshold - HH 65 years and over': 53112 },
                { County: 'Hillsborough', FIPS: '12057', Households: 593029, 'Poverty Households': 83681, 'ALICE Households': 189779, 'Above ALICE Households': 319569, 'ALICE Threshold - HH under 65': 72119, 'ALICE Threshold - HH 65 years and over': 65988 },
                { County: 'Holmes', FIPS: '12059', Households: 7087, 'Poverty Households': 1135, 'ALICE Households': 3239, 'Above ALICE Households': 2713, 'ALICE Threshold - HH under 65': 62586, 'ALICE Threshold - HH 65 years and over': 49236 },
                { County: 'Indian River', FIPS: '12061', Households: 72833, 'Poverty Households': 8920, 'ALICE Households': 22197, 'Above ALICE Households': 41716, 'ALICE Threshold - HH under 65': 68414, 'ALICE Threshold - HH 65 years and over': 59184 },
                { County: 'Jackson', FIPS: '12063', Households: 17038, 'Poverty Households': 3174, 'ALICE Households': 6883, 'Above ALICE Households': 6981, 'ALICE Threshold - HH under 65': 59453, 'ALICE Threshold - HH 65 years and over': 50064 },
                { County: 'Jefferson', FIPS: '12065', Households: 5675, 'Poverty Households': 1241, 'ALICE Households': 1835, 'Above ALICE Households': 2599, 'ALICE Threshold - HH under 65': 67058, 'ALICE Threshold - HH 65 years and over': 57720 },
                { County: 'Lafayette', FIPS: '12067', Households: 2619, 'Poverty Households': 497, 'ALICE Households': 877, 'Above ALICE Households': 1245, 'ALICE Threshold - HH under 65': 68450, 'ALICE Threshold - HH 65 years and over': 52620 },
                { County: 'Lake', FIPS: '12069', Households: 172803, 'Poverty Households': 22832, 'ALICE Households': 61632, 'Above ALICE Households': 88339, 'ALICE Threshold - HH under 65': 72279, 'ALICE Threshold - HH 65 years and over': 64008 },
                { County: 'Lee', FIPS: '12071', Households: 326338, 'Poverty Households': 38827, 'ALICE Households': 117347, 'Above ALICE Households': 170164, 'ALICE Threshold - HH under 65': 74930, 'ALICE Threshold - HH 65 years and over': 60288 },
                { County: 'Leon', FIPS: '12073', Households: 124867, 'Poverty Households': 19980, 'ALICE Households': 37350, 'Above ALICE Households': 67537, 'ALICE Threshold - HH under 65': 60036, 'ALICE Threshold - HH 65 years and over': 60744 },
                { County: 'Levy', FIPS: '12075', Households: 17976, 'Poverty Households': 3022, 'ALICE Households': 6247, 'Above ALICE Households': 8707, 'ALICE Threshold - HH under 65': 58535, 'ALICE Threshold - HH 65 years and over': 50748 },
                { County: 'Liberty', FIPS: '12077', Households: 2554, 'Poverty Households': 525, 'ALICE Households': 862, 'Above ALICE Households': 1167, 'ALICE Threshold - HH under 65': 58728, 'ALICE Threshold - HH 65 years and over': 50748 },
                { County: 'Madison', FIPS: '12079', Households: 6980, 'Poverty Households': 1332, 'ALICE Households': 2683, 'Above ALICE Households': 2965, 'ALICE Threshold - HH under 65': 57313, 'ALICE Threshold - HH 65 years and over': 51384 },
                { County: 'Manatee', FIPS: '12081', Households: 190091, 'Poverty Households': 20632, 'ALICE Households': 58923, 'Above ALICE Households': 110536, 'ALICE Threshold - HH under 65': 69134, 'ALICE Threshold - HH 65 years and over': 62964 },
                { County: 'Marion', FIPS: '12083', Households: 171369, 'Poverty Households': 24550, 'ALICE Households': 60631, 'Above ALICE Households': 86188, 'ALICE Threshold - HH under 65': 61984, 'ALICE Threshold - HH 65 years and over': 54504 },
                { County: 'Martin', FIPS: '12085', Households: 69169, 'Poverty Households': 9420, 'ALICE Households': 22283, 'Above ALICE Households': 37466, 'ALICE Threshold - HH under 65': 74289, 'ALICE Threshold - HH 65 years and over': 61968 },
                { County: 'Miami-Dade', FIPS: '12086', Households: 985935, 'Poverty Households': 145803, 'ALICE Households': 381666, 'Above ALICE Households': 458466, 'ALICE Threshold - HH under 65': 81658, 'ALICE Threshold - HH 65 years and over': 69744 },
                { County: 'Monroe', FIPS: '12087', Households: 32559, 'Poverty Households': 3300, 'ALICE Households': 11494, 'Above ALICE Households': 17765, 'ALICE Threshold - HH under 65': 82680, 'ALICE Threshold - HH 65 years and over': 72744 },
                { County: 'Nassau', FIPS: '12089', Households: 41045, 'Poverty Households': 4289, 'ALICE Households': 9593, 'Above ALICE Households': 27163, 'ALICE Threshold - HH under 65': 66289, 'ALICE Threshold - HH 65 years and over': 59880 },
                { County: 'Okaloosa', FIPS: '12091', Households: 86541, 'Poverty Households': 9037, 'ALICE Households': 20324, 'Above ALICE Households': 57180, 'ALICE Threshold - HH under 65': 62560, 'ALICE Threshold - HH 65 years and over': 59748 },
                { County: 'Okeechobee', FIPS: '12093', Households: 15187, 'Poverty Households': 2567, 'ALICE Households': 6094, 'Above ALICE Households': 6526, 'ALICE Threshold - HH under 65': 63806, 'ALICE Threshold - HH 65 years and over': 51564 },
                { County: 'Orange', FIPS: '12095', Households: 556557, 'Poverty Households': 71773, 'ALICE Households': 175216, 'Above ALICE Households': 309568, 'ALICE Threshold - HH under 65': 70235, 'ALICE Threshold - HH 65 years and over': 66072 },
                { County: 'Osceola', FIPS: '12097', Households: 154722, 'Poverty Households': 16557, 'ALICE Households': 54729, 'Above ALICE Households': 83436, 'ALICE Threshold - HH under 65': 74244, 'ALICE Threshold - HH 65 years and over': 64644 },
                { County: 'Palm Beach', FIPS: '12099', Households: 605132, 'Poverty Households': 66984, 'ALICE Households': 209153, 'Above ALICE Households': 328995, 'ALICE Threshold - HH under 65': 83531, 'ALICE Threshold - HH 65 years and over': 69324 },
                { County: 'Pasco', FIPS: '12101', Households: 239952, 'Poverty Households': 28379, 'ALICE Households': 89777, 'Above ALICE Households': 121796, 'ALICE Threshold - HH under 65': 76682, 'ALICE Threshold - HH 65 years and over': 64032 },
                { County: 'Pinellas', FIPS: '12103', Households: 439896, 'Poverty Households': 47499, 'ALICE Households': 156921, 'Above ALICE Households': 235476, 'ALICE Threshold - HH under 65': 66645, 'ALICE Threshold - HH 65 years and over': 66348 },
                { County: 'Polk', FIPS: '12105', Households: 306915, 'Poverty Households': 39366, 'ALICE Households': 102469, 'Above ALICE Households': 165080, 'ALICE Threshold - HH under 65': 66763, 'ALICE Threshold - HH 65 years and over': 55320 },
                { County: 'Putnam', FIPS: '12107', Households: 30650, 'Poverty Households': 7218, 'ALICE Households': 10095, 'Above ALICE Households': 13337, 'ALICE Threshold - HH under 65': 56274, 'ALICE Threshold - HH 65 years and over': 49968 },
                { County: 'St. Johns', FIPS: '12109', Households: 126240, 'Poverty Households': 9460, 'ALICE Households': 31624, 'Above ALICE Households': 85156, 'ALICE Threshold - HH under 65': 72958, 'ALICE Threshold - HH 65 years and over': 63660 },
                { County: 'St. Lucie', FIPS: '12111', Households: 145735, 'Poverty Households': 16727, 'ALICE Households': 56160, 'Above ALICE Households': 72848, 'ALICE Threshold - HH under 65': 72071, 'ALICE Threshold - HH 65 years and over': 59904 },
                { County: 'Santa Rosa', FIPS: '12113', Households: 72969, 'Poverty Households': 5573, 'ALICE Households': 19485, 'Above ALICE Households': 47911, 'ALICE Threshold - HH under 65': 70110, 'ALICE Threshold - HH 65 years and over': 57876 },
                { County: 'Sarasota', FIPS: '12115', Households: 218010, 'Poverty Households': 20539, 'ALICE Households': 73054, 'Above ALICE Households': 124417, 'ALICE Threshold - HH under 65': 69536, 'ALICE Threshold - HH 65 years and over': 65184 },
                { County: 'Seminole', FIPS: '12117', Households: 189580, 'Poverty Households': 16465, 'ALICE Households': 66980, 'Above ALICE Households': 106135, 'ALICE Threshold - HH under 65': 72225, 'ALICE Threshold - HH 65 years and over': 67548 },
                { County: 'Sumter', FIPS: '12119', Households: 66941, 'Poverty Households': 5377, 'ALICE Households': 20760, 'Above ALICE Households': 40804, 'ALICE Threshold - HH under 65': 71582, 'ALICE Threshold - HH 65 years and over': 54228 },
                { County: 'Suwannee', FIPS: '12121', Households: 15567, 'Poverty Households': 2270, 'ALICE Households': 5664, 'Above ALICE Households': 7633, 'ALICE Threshold - HH under 65': 59386, 'ALICE Threshold - HH 65 years and over': 50808 },
                { County: 'Taylor', FIPS: '12123', Households: 7571, 'Poverty Households': 1206, 'ALICE Households': 3408, 'Above ALICE Households': 2957, 'ALICE Threshold - HH under 65': 59681, 'ALICE Threshold - HH 65 years and over': 49476 },
                { County: 'Union', FIPS: '12125', Households: 4192, 'Poverty Households': 715, 'ALICE Households': 1101, 'Above ALICE Households': 2376, 'ALICE Threshold - HH under 65': 56479, 'ALICE Threshold - HH 65 years and over': 50844 },
                { County: 'Volusia', FIPS: '12127', Households: 243904, 'Poverty Households': 27715, 'ALICE Households': 88021, 'Above ALICE Households': 128168, 'ALICE Threshold - HH under 65': 64860, 'ALICE Threshold - HH 65 years and over': 58392 },
                { County: 'Wakulla', FIPS: '12129', Households: 12187, 'Poverty Households': 789, 'ALICE Households': 4471, 'Above ALICE Households': 6927, 'ALICE Threshold - HH under 65': 68598, 'ALICE Threshold - HH 65 years and over': 55100 },
                { County: 'Walton', FIPS: '12131', Households: 35435, 'Poverty Households': 4280, 'ALICE Households': 10664, 'Above ALICE Households': 20491, 'ALICE Threshold - HH under 65': 63974, 'ALICE Threshold - HH 65 years and over': 58474 },
                { County: 'Washington', FIPS: '12133', Households: 9282, 'Poverty Households': 1607, 'ALICE Households': 3399, 'Above ALICE Households': 4276, 'ALICE Threshold - HH under 65': 60688, 'ALICE Threshold - HH 65 years and over': 48176 }
            ];
            
            // Calculate percentages for each county
            floridaALICEData.forEach(row => {
                row['ALICE_Percent'] = parseFloat(((row['ALICE Households'] / row.Households) * 100).toFixed(1));
                row['Poverty_Percent'] = parseFloat(((row['Poverty Households'] / row.Households) * 100).toFixed(1));
                row['Vulnerable_Percent'] = parseFloat((((row['ALICE Households'] + row['Poverty Households']) / row.Households) * 100).toFixed(1));
                row['Above_ALICE_Percent'] = parseFloat(((row['Above ALICE Households'] / row.Households) * 100).toFixed(1));
            });
            
            // Store as CSV data
            csvData = floridaALICEData;
            csvFields = Object.keys(floridaALICEData[0]);
            
            // Update CSV match field dropdown
            const csvMatchField = document.getElementById('csvMatchField');
            csvMatchField.innerHTML = '<option value="">-- Select CSV field to match --</option>';
            csvFields.forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                csvMatchField.appendChild(option);
            });
            
            // Show field mapping section
            document.getElementById('csvFieldMapping').style.display = 'block';
            
            // Auto-select Florida counties geography
            document.getElementById('geographyType').value = 'arc_counties';
            handleGeographyChange();
            
            // Auto-select FIPS matching and highlight next step
            setTimeout(() => {
                document.getElementById('csvMatchField').value = 'FIPS';
                document.getElementById('geoMatchField').value = 'FIPS';
                
                // Highlight the Match button
                const matchBtn = document.querySelector('button[onclick="matchAndMergeData()"]');
                if (matchBtn) {
                    matchBtn.style.animation = 'pulse 2s infinite';
                    matchBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    matchBtn.innerHTML = '⭐ CLICK HERE TO CONTINUE - Match Florida Counties';
                }
                
                showStatus('Step 1 Complete! Now click the green "CLICK HERE TO CONTINUE" button below to match the data to Florida counties.', 'success');
                
                // Add visual arrow pointing to button
                const arrow = document.createElement('div');
                arrow.innerHTML = '👇 NEXT STEP 👇';
                arrow.style.cssText = 'text-align: center; font-size: 20px; color: #4CAF50; font-weight: bold; margin: 10px 0; animation: bounce 1s infinite;';
                matchBtn.parentElement.insertBefore(arrow, matchBtn);
            }, 500);
        }
        
        // Load sample CSV data for testing
        function loadSampleCSV(type) {
            let sampleData;
            
            switch(type) {
                case 'divisions':
                    sampleData = [
                        { Division: 'Pacific Division', Total_Pop_2023: 15420000, Med_HH_Inc_2023: 78900, Diversity_Index: 0.82 },
                        { Division: 'Western Division', Total_Pop_2023: 8930000, Med_HH_Inc_2023: 65400, Diversity_Index: 0.68 },
                        { Division: 'Central Division', Total_Pop_2023: 12750000, Med_HH_Inc_2023: 59200, Diversity_Index: 0.71 },
                        { Division: 'Eastern Division', Total_Pop_2023: 18650000, Med_HH_Inc_2023: 72100, Diversity_Index: 0.75 },
                        { Division: 'Northern Division', Total_Pop_2023: 6780000, Med_HH_Inc_2023: 56800, Diversity_Index: 0.63 },
                        { Division: 'Southern Division', Total_Pop_2023: 14320000, Med_HH_Inc_2023: 53900, Diversity_Index: 0.69 },
                        { Division: 'Northeastern Division', Total_Pop_2023: 21450000, Med_HH_Inc_2023: 81200, Diversity_Index: 0.79 }
                    ];
                    break;
                    
                case 'counties':
                    sampleData = [
                        { FIPS: '06037', County: 'Los Angeles', State: 'California', Total_Pop_2023: 9721138, Med_HH_Inc_2023: 70372, Pov_Rate_2023: 14.2 },
                        { FIPS: '17031', County: 'Cook', State: 'Illinois', Total_Pop_2023: 5140675, Med_HH_Inc_2023: 65781, Pov_Rate_2023: 16.8 },
                        { FIPS: '48201', County: 'Harris', State: 'Texas', Total_Pop_2023: 4835570, Med_HH_Inc_2023: 62982, Pov_Rate_2023: 15.1 },
                        { FIPS: '04013', County: 'Maricopa', State: 'Arizona', Total_Pop_2023: 4420568, Med_HH_Inc_2023: 68917, Pov_Rate_2023: 12.9 },
                        { FIPS: '06073', County: 'San Diego', State: 'California', Total_Pop_2023: 3286069, Med_HH_Inc_2023: 84454, Pov_Rate_2023: 10.8 },
                        { FIPS: '06059', County: 'Orange', State: 'California', Total_Pop_2023: 3167809, Med_HH_Inc_2023: 95198, Pov_Rate_2023: 8.9 },
                        { FIPS: '12086', County: 'Miami-Dade', State: 'Florida', Total_Pop_2023: 2665874, Med_HH_Inc_2023: 51347, Pov_Rate_2023: 18.7 },
                        { FIPS: '36047', County: 'Kings', State: 'New York', Total_Pop_2023: 2590516, Med_HH_Inc_2023: 59227, Pov_Rate_2023: 19.5 },
                        { FIPS: '48113', County: 'Dallas', State: 'Texas', Total_Pop_2023: 2552213, Med_HH_Inc_2023: 67534, Pov_Rate_2023: 13.4 },
                        { FIPS: '06065', County: 'Riverside', State: 'California', Total_Pop_2023: 2458395, Med_HH_Inc_2023: 74582, Pov_Rate_2023: 11.6 }
                    ];
                    break;
                    
                case 'regions':
                    sampleData = [
                        { Region: 'California', Total_Pop_2023: 39029342, Med_Age_2023: 36.8, College_Grad_Rate: 33.9 },
                        { Region: 'Texas Gulf', Total_Pop_2023: 8934259, Med_Age_2023: 34.2, College_Grad_Rate: 29.1 },
                        { Region: 'Greater New York', Total_Pop_2023: 20201249, Med_Age_2023: 38.9, College_Grad_Rate: 38.7 },
                        { Region: 'Illinois', Total_Pop_2023: 12620571, Med_Age_2023: 37.5, College_Grad_Rate: 34.2 },
                        { Region: 'Ohio', Total_Pop_2023: 11780017, Med_Age_2023: 39.3, College_Grad_Rate: 28.4 },
                        { Region: 'Pennsylvania', Total_Pop_2023: 13002700, Med_Age_2023: 40.8, College_Grad_Rate: 31.8 },
                        { Region: 'Michigan', Total_Pop_2023: 10037261, Med_Age_2023: 39.7, College_Grad_Rate: 29.5 },
                        { Region: 'North Florida', Total_Pop_2023: 6834759, Med_Age_2023: 42.1, College_Grad_Rate: 32.6 },
                        { Region: 'Central Florida', Total_Pop_2023: 7982341, Med_Age_2023: 40.3, College_Grad_Rate: 30.2 },
                        { Region: 'South Florida', Total_Pop_2023: 9145829, Med_Age_2023: 43.5, College_Grad_Rate: 35.8 }
                    ];
                    break;
            }
            
            // Simulate CSV upload
            csvData = sampleData;
            csvFields = Object.keys(sampleData[0]);
            
            // Update CSV match field dropdown
            const csvMatchField = document.getElementById('csvMatchField');
            csvMatchField.innerHTML = '<option value="">-- Select CSV field to match --</option>';
            csvFields.forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                csvMatchField.appendChild(option);
            });
            
            document.getElementById('csvFieldMapping').style.display = 'block';
            
            showStatus(`Loaded sample ${type} data with ${sampleData.length} rows`, 'success');
            
            // Auto-select matching geography
            switch(type) {
                case 'divisions':
                    document.getElementById('geographyType').value = 'divisions';
                    handleGeographyChange();
                    setTimeout(() => {
                        document.getElementById('csvMatchField').value = 'Division';
                        document.getElementById('geoMatchField').value = 'Division';
                    }, 500);
                    break;
                case 'counties':
                    document.getElementById('geographyType').value = 'arc_counties';
                    handleGeographyChange();
                    setTimeout(() => {
                        document.getElementById('csvMatchField').value = 'FIPS';
                        document.getElementById('geoMatchField').value = 'FIPS';
                    }, 500);
                    break;
                case 'regions':
                    document.getElementById('geographyType').value = 'regions';
                    handleGeographyChange();
                    setTimeout(() => {
                        document.getElementById('csvMatchField').value = 'Region';
                        document.getElementById('geoMatchField').value = 'Region';
                    }, 500);
                    break;
            }
        }
        
        // Format values for display
        function formatLargeNumber(num) {
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            } else {
                return num.toString();
            }
        }

        function formatValue(value, fieldName) {
            // Handle various null/missing value representations
            if (value === null || value === undefined || value === '' || 
                value === 'NULL' || value === 'null' || value === 'N/A' || 
                value === 'n/a' || value === '#N/A' || value === '-999' || value === '-9999') {
                return 'No Data';
            }
            
            // Handle string numbers with commas and currency symbols (e.g., "$1,234,567")
            let cleanValue = value;
            if (typeof value === 'string') {
                cleanValue = value.replace(/[$,]/g, '').trim();  // Remove $ and commas
                // Check for other missing data indicators
                if (cleanValue === '' || cleanValue.toLowerCase() === 'null' || 
                    cleanValue.toLowerCase() === 'n/a' || cleanValue === '0.00' && fieldName.toLowerCase().includes('val')) {
                    return 'No Data';
                }
            }
            
            const num = parseFloat(cleanValue);
            if (isNaN(num)) {
                // If it's not a number, return as-is but warn for debugging
                if (fieldName && (fieldName.toLowerCase().includes('rate') || 
                                 fieldName.toLowerCase().includes('income') ||
                                 fieldName.toLowerCase().includes('pop') ||
                                 fieldName.toLowerCase().includes('val'))) {
                    console.warn(`Non-numeric value for numeric field ${fieldName}:`, value);
                }
                return value;
            }
            
            // Handle percentage fields (unemployment rates, etc.)
            if (fieldName && (fieldName.toLowerCase().includes('rate') || 
                             fieldName.toLowerCase().includes('percent') ||
                             fieldName.toLowerCase().includes('pct'))) {
                
                // ASSUMPTION: ArcGIS demographic data stores rates as already-formatted percentages
                // So 5.2 in the data = 5.2% unemployment rate (NOT 0.052 decimal)
                
                if (fieldName.toLowerCase().includes('unemp')) {
                    // Unemployment rates: reasonable range is 0-30%
                    if (num >= 0 && num <= 30) {
                        return num.toFixed(1) + '%';
                    } else if (num > 30 && num <= 100) {
                        // Suspiciously high - likely data quality issue
                        console.warn(`Suspicious unemployment rate: ${num}% for field ${fieldName} - this may indicate data quality issues in the ArcGIS source`);
                        return num.toFixed(1) + '% (Suspect Data)';
                    } else {
                        console.warn(`Unrealistic unemployment rate: ${num}% for field ${fieldName} - this is likely a data error`);
                        return 'Data Error';
                    }
                } else {
                    // Other rate fields - assume they're already percentages
                    if (num >= 0 && num <= 100) {
                        return num.toFixed(1) + '%';
                    } else if (num > 100) {
                        console.warn(`Suspicious percentage value: ${num} for field ${fieldName}`);
                        return num.toFixed(1) + '% (Check Data)';
                    } else {
                        return num.toFixed(1) + '%';
                    }
                }
            }
            
            // Handle income/currency fields
            if (fieldName && (fieldName.toLowerCase().includes('income') || 
                             fieldName.toLowerCase().includes('val') ||
                             fieldName.toLowerCase().includes('wage'))) {
                // Don't show $0 for home values - likely missing data
                if (num === 0 && fieldName.toLowerCase().includes('val')) {
                    return 'No Data';
                }
                return '$' + formatLargeNumber(num);
            }
            
            // Handle population/count fields
            if (fieldName && (fieldName.toLowerCase().includes('pop') || 
                             fieldName.toLowerCase().includes('hh') ||
                             fieldName.toLowerCase().includes('total'))) {
                return formatLargeNumber(num);
            }
            
            // Handle zip codes - always format as 5 digits with leading zeros for New England
            if (fieldName && (fieldName.toLowerCase().includes('zip') || 
                             fieldName.toLowerCase().includes('postal'))) {
                if (num >= 1 && num <= 99999) {
                    return num.toString().padStart(5, '0'); // Add leading zeros for New England zips
                }
                return num.toString();
            }
            
            // Default formatting
            if (num >= 100000) {
                return formatLargeNumber(num);
            } else if (num >= 1000) {
                return num.toLocaleString();
            } else if (num % 1 === 0) {
                return num.toString();
            } else {
                return num.toFixed(1);
            }
        }

        // Build field accordion for detailed data view
        function buildFieldAccordion(props) {
            const accordionId = 'accordion_' + Math.random().toString(36).substr(2, 9);
            
            // Categorize fields
            const categories = {
                'Demographics': [],
                'Economics': [],
                'Housing': [],
                'Geography': [],
                'Other': []
            };
            
            Object.keys(props).forEach(key => {
                // Skip system fields, problematic fields, and technical metadata users don't need
                if (key === 'OBJECTID' || key === 'Shape' || key === 'GlobalID' || 
                    (((key.toLowerCase().includes('unemp') && key.includes('WAVG')) ||
                    key === 'Unemp_Rate_2023_WAVG' ||
                    key === 'Unemp_Rate_2023_CALC' ||
                    key === 'Avg_Home_Val_2023_WAVG' ||
                    key.toLowerCase().includes('avg_') ||
                    key.toLowerCase().includes('average') ||
                    (key.includes('WAVG') && key.toLowerCase().includes('val')) ||
                    (key.includes('CALC') && key.toLowerCase().includes('rate')) ||
                    // Technical geographic fields users don't need
                    key.toLowerCase().includes('shape') ||
                    key.toLowerCase().includes('area') ||
                    key.toLowerCase().includes('length') ||
                    key.toLowerCase().includes('acres') ||
                    key.toLowerCase().includes('sqmi') ||
                    key.toLowerCase().includes('sq_mi') ||
                    // Division codes and technical IDs
                    key.toLowerCase().includes('div_code') ||
                    key.toLowerCase().includes('division_code')) &&
                    key !== 'Calculated_Unemp_Rate_2023')) {
                    return;
                }
                
                const value = props[key];
                if (value === null || value === undefined || value === '') return;
                
                const keyLower = key.toLowerCase();
                if (keyLower.includes('pop') || keyLower.includes('age') || keyLower.includes('diversity') || 
                    keyLower.includes('race') || keyLower.includes('ethnicity') || keyLower.includes('hh')) {
                    categories.Demographics.push({key, value});
                } else if (keyLower.includes('income') || keyLower.includes('inc') || keyLower.includes('poverty') || 
                          keyLower.includes('employ') || keyLower.includes('wage')) {
                    categories.Economics.push({key, value});
                } else if (keyLower.includes('home') || keyLower.includes('house') || keyLower.includes('rent') || 
                          keyLower.includes('val') || keyLower.includes('unit')) {
                    categories.Housing.push({key, value});
                } else if (keyLower.includes('fips') || keyLower.includes('county') || keyLower.includes('state') || 
                          keyLower.includes('region') || keyLower.includes('chapter') || keyLower.includes('division') ||
                          keyLower.includes('sq_mi') || keyLower.includes('acres')) {
                    categories.Geography.push({key, value});
                } else {
                    categories.Other.push({key, value});
                }
            });
            
            let html = `<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0;">`;
            html += `<div style="cursor: pointer; padding: 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; font-weight: bold; color: #495057;" onclick="toggleAccordion('${accordionId}')">`;
            html += `<span>📊 View All ${Object.keys(props).length} Fields</span>`;
            html += `<span id="${accordionId}_arrow" style="float: right; transition: transform 0.2s;">▼</span>`;
            html += `</div>`;
            html += `<div id="${accordionId}" style="display: none; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-top: none; background: white;">`;
            
            // Add categories
            Object.keys(categories).forEach(categoryName => {
                const fields = categories[categoryName];
                if (fields.length > 0) {
                    html += `<div style="padding: 8px; border-bottom: 1px solid #f0f0f0;">`;
                    html += `<div style="font-weight: bold; font-size: 11px; color: #B71C1C; margin-bottom: 5px;">${categoryName} (${fields.length})</div>`;
                    html += `<table style="width: 100%; font-size: 10px;">`;
                    
                    // Group fields into sets of 5 for better readability
                    for (let i = 0; i < fields.length; i += 5) {
                        const fieldGroup = fields.slice(i, i + 5);
                        
                        // Add subtle divider between groups (except for first group)
                        if (i > 0) {
                            html += `<tr><td colspan="2" style="height: 8px; border-bottom: 1px solid #e9ecef;"></td></tr>`;
                        }
                        
                        fieldGroup.forEach((field, index) => {
                            const label = field.key.replace(/_/g, ' ').replace(/2023/g, '').trim();
                            const isEven = index % 2 === 0;
                            const bgColor = isEven ? '#f8f9fa' : '#ffffff';
                            
                            html += `<tr style="background: ${bgColor};">`;
                            html += `<td style="padding: 4px 8px 4px 6px; color: #666; width: 60%;">${label}:</td>`;
                            html += `<td style="padding: 4px 6px; text-align: right; font-weight: bold;">${formatValue(field.value, field.key)}</td>`;
                            html += `</tr>`;
                        });
                    }
                    
                    html += `</table></div>`;
                }
            });
            
            html += `</div></div>`;
            return html;
        }

        // Build enhanced popup for bivariate analysis
        function buildEnhancedPopup(props, xVar, yVar, xVal, yVal) {
            const name = props.NAME || props.County || props.Chapter || props.Region || props.Division || 'Feature';
            const state = props.State || props.STATE || '';
            
            let html = `<div style="font-family: -apple-system, Arial, sans-serif; max-width: 350px;">`;
            html += `<h3 style="color: #B71C1C; margin: 0 0 8px 0; font-size: 16px;">${name}</h3>`;
            
            if (state) {
                html += `<div style="color: #666; font-size: 12px; margin-bottom: 10px;">${state}</div>`;
            }
            
            // Bivariate values
            html += `<div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 10px; border-radius: 6px; margin: 10px 0;">`;
            html += `<strong style="color: #1976D2;">Bivariate Analysis:</strong><br>`;
            html += `<table style="width: 100%; margin-top: 5px;">`;
            html += `<tr><td style="color: #666;">${xVar}:</td><td style="text-align: right;"><strong>${formatValue(xVal, xVar)}</strong></td></tr>`;
            html += `<tr><td style="color: #666;">${yVar}:</td><td style="text-align: right;"><strong>${formatValue(yVal, yVar)}</strong></td></tr>`;
            html += `</table></div>`;
            
            // Key demographics
            const demographics = ['Pop_2023', 'Total_HH_2023', 'Med_HH_Inc_2023', 'Med_Home_Val_2023', 
                                'Median_Age_2023', 'Diversity_Index_2023', 'Unemp_Rate_2023'];
            
            let hasDemographics = false;
            let demoHtml = `<div style="margin-top: 10px;"><strong style="color: #666; font-size: 12px;">Key Demographics:</strong>`;
            demoHtml += `<table style="width: 100%; font-size: 12px; margin-top: 5px;">`;
            
            demographics.forEach(field => {
                if (props[field] && field !== xVar && field !== yVar) {
                    hasDemographics = true;
                    const label = field.replace(/_/g, ' ').replace(/2023/g, '').trim();
                    demoHtml += `<tr><td style="color: #888; padding: 2px 0;">${label}:</td>`;
                    demoHtml += `<td style="text-align: right; padding: 2px 0;">${formatValue(props[field], field)}</td></tr>`;
                }
            });
            
            if (hasDemographics) {
                html += demoHtml + `</table></div>`;
            }
            
            // Geography hierarchy
            if (props.Chapter || props.Region || props.Division) {
                html += `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">`;
                html += `<strong style="color: #666; font-size: 12px;">ARC Geography:</strong><br>`;
                if (props.Chapter) html += `<div style="font-size: 11px; color: #2196F3;">Chapter: ${props.Chapter}</div>`;
                if (props.Region) html += `<div style="font-size: 11px; color: #9c27b0;">Region: ${props.Region}</div>`;
                if (props.Division) html += `<div style="font-size: 11px; color: #4CAF50;">Division: ${props.Division}</div>`;
                html += `</div>`;
            }
            
            // All Fields Accordion
            html += buildFieldAccordion(props);
            
            // Field count
            html += `<div style="font-size: 10px; color: #999; margin-top: 10px; text-align: center; border-top: 1px solid #f0f0f0; padding-top: 5px;">`;
            html += `${Object.keys(props).length} fields available`;
            html += `</div></div>`;
            
            return html;
        }
        
        // Build initial popup for non-bivariate view
        function buildInitialPopup(props, serviceName) {
            const name = props.NAME || props.County || props.Chapter || props.Region || props.Division || 'Feature';
            
            let html = `<div style="font-family: -apple-system, Arial, sans-serif; max-width: 350px;">`;
            html += `<h3 style="color: #B71C1C; margin: 0 0 8px 0; font-size: 16px;">${name}</h3>`;
            html += `<div style="color: #666; font-size: 11px; margin-bottom: 10px;">${serviceName}</div>`;
            
            // Organize fields by user priority - focus on essential demographics only
            const fieldCategories = {
                // Location (simplified - no codes)
                'location': ['State', 'County', 'Chapter', 'Region', 'Division'],
                // Age demographics 
                'age': ['Adult_Pop_2023_SUM', 'Youth_Pop_2023_SUM', 'Senior_Pop_2023_SUM', 'Median_Age_2023'],
                // Race/ethnicity demographics
                'race': ['Black_Pop_2023_SUM', 'White_Pop_2023_SUM', 'Hispanic_Pop_2023_SUM'],
                // Employment
                'employment': ['Calculated_Unemp_Rate_2023', 'Unemp_Pop_2023_SUM'],
                // Essential stats only
                'essential': ['Total_Pop_2023_SUM', 'Med_HH_Inc_2023']
            };
            
            html += `<table style="width: 100%; font-size: 12px; border-collapse: collapse;">`;
            let fieldCount = 0;
            let rowIndex = 0;
            
            // Process each category in order
            Object.keys(fieldCategories).forEach(category => {
                fieldCategories[category].forEach(field => {
                    // Skip problematic fields and technical metadata users don't need
                    const isProblemField = ((field.toLowerCase().includes('unemp') && field.includes('WAVG')) ||
                                         field === 'Unemp_Rate_2023_WAVG' ||
                                         field === 'Unemp_Rate_2023_CALC' ||
                                         field === 'Avg_Home_Val_2023_WAVG' ||
                                         field.toLowerCase().includes('avg_') ||
                                         field.toLowerCase().includes('average') ||
                                         (field.includes('WAVG') && field.toLowerCase().includes('val')) ||
                                         (field.includes('CALC') && field.toLowerCase().includes('rate')) ||
                                         // Technical geographic fields users don't need
                                         field.toLowerCase().includes('shape') ||
                                         field.toLowerCase().includes('area') ||
                                         field.toLowerCase().includes('length') ||
                                         field.toLowerCase().includes('acres') ||
                                         field.toLowerCase().includes('sqmi') ||
                                         field.toLowerCase().includes('sq_mi') ||
                                         // Division codes and technical IDs
                                         field.toLowerCase().includes('div_code') ||
                                         field.toLowerCase().includes('division_code')) &&
                                         field !== 'Calculated_Unemp_Rate_2023';
                                         
                    if (props[field] && fieldCount < 12 && !isProblemField) {
                        const bgColor = rowIndex % 2 === 0 ? '#f8f9fa' : '#ffffff';
                        const label = field.replace(/_/g, ' ').replace(/2023/g, '').replace(/SUM/g, '').trim();
                        
                        html += `<tr style="background-color: ${bgColor};">`;
                        html += `<td style="color: #666; padding: 6px 8px; border: none;">${label}:</td>`;
                        html += `<td style="text-align: right; padding: 6px 8px; border: none;"><strong>${formatValue(props[field], field)}</strong></td>`;
                        html += `</tr>`;
                        fieldCount++;
                        rowIndex++;
                    }
                });
            });
            
            // Add any other interesting fields not already shown
            const allPriorityFields = Object.values(fieldCategories).flat();
            for (let key in props) {
                // Skip problematic fields and technical metadata users don't need
                const isProblemField = ((key.toLowerCase().includes('unemp') && key.includes('WAVG')) ||
                                     key === 'Unemp_Rate_2023_WAVG' ||
                                     key === 'Unemp_Rate_2023_CALC' ||
                                     key === 'Avg_Home_Val_2023_WAVG' ||
                                     key.toLowerCase().includes('avg_') ||
                                     key.toLowerCase().includes('average') ||
                                     (key.includes('WAVG') && key.toLowerCase().includes('val')) ||
                                     (key.includes('CALC') && key.toLowerCase().includes('rate')) ||
                                     // Technical geographic fields users don't need
                                     key.toLowerCase().includes('shape') ||
                                     key.toLowerCase().includes('area') ||
                                     key.toLowerCase().includes('length') ||
                                     key.toLowerCase().includes('acres') ||
                                     key.toLowerCase().includes('sqmi') ||
                                     key.toLowerCase().includes('sq_mi') ||
                                     // Division codes and technical IDs
                                     key.toLowerCase().includes('div_code') ||
                                     key.toLowerCase().includes('division_code')) &&
                                     key !== 'Calculated_Unemp_Rate_2023';
                                     
                if (fieldCount < 15 && !allPriorityFields.includes(key) && props[key] && 
                    key !== 'OBJECTID' && key !== 'Shape' && key !== 'GlobalID' && !isProblemField) {
                    const bgColor = rowIndex % 2 === 0 ? '#f8f9fa' : '#ffffff';
                    const label = key.replace(/_/g, ' ').replace(/2023/g, '').replace(/SUM/g, '').trim();
                    
                    html += `<tr style="background-color: ${bgColor};">`;
                    html += `<td style="color: #888; padding: 6px 8px; border: none; font-size: 11px;">${label}:</td>`;
                    html += `<td style="text-align: right; padding: 6px 8px; border: none; font-size: 11px;">${formatValue(props[key], key)}</td>`;
                    html += `</tr>`;
                    fieldCount++;
                    rowIndex++;
                }
            }
            
            html += `</table>`;
            
            // Add accordion for all fields
            html += buildFieldAccordion(props);
            
            html += `</div>`;
            
            return html;
        }
        
        // Quick demo function with different types
        async function quickDemo(demoType) {
            showStatus(`Starting ${demoType} demo... Watch me load data and create a map!`, 'info');
            
            // Reset everything first
            resetAll();
            
            switch(demoType) {
                case 'divisions':
                    await runDivisionDemo();
                    break;
                case 'regions':
                    await runRegionDemo();
                    break;
                case 'chapters':
                    await runChapterDemo();
                    break;
                case 'counties':
                    await runCountyDemo();
                    break;
                case 'csv-division':
                    await runCSVDivisionDemo();
                    break;
                case 'csv-county':
                    await runCSVCountyDemo();
                    break;
                case 'alice-florida':
                    await runALICEFloridaDemo();
                    break;
                default:
                    await runDivisionDemo();
            }
        }
        
        async function runDivisionDemo() {
            setTimeout(async () => {
                showStatus('Step 1: Loading ARC Divisions (7 divisions with full demographics)...', 'info');
                await loadRedCrossDivisions();
            }, 1000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 2: Selecting Population vs Median Household Income for analysis...', 'info');
                    selectDemoVariables('Pop', 'Med_HH_Inc');
                    
                    setTimeout(() => {
                        showStatus('Step 3: Generating bivariate map...', 'info');
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('Division demo complete! Notice how the 7 divisions show different color patterns. Click any division for details!', 'success');
                        }, 2000);
                    }, 2000);
                }
            }, 6000);
        }
        
        async function runRegionDemo() {
            setTimeout(async () => {
                showStatus('Step 1: Loading ARC Regions (59 regions across the US)...', 'info');
                await loadRedCrossRegions();
            }, 1000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 2: Selecting Population vs Median Income...', 'info');
                    selectDemoVariables('Pop', 'Med_HH_Inc');
                    
                    setTimeout(() => {
                        showStatus('Step 3: Creating regional bivariate map...', 'info');
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('Region demo complete! 59 regions colored by population vs median income. Dark colors = high pop & high income!', 'success');
                        }, 2000);
                    }, 2000);
                }
            }, 7000);
        }
        
        async function runChapterDemo() {
            setTimeout(async () => {
                showStatus('Step 1: Loading ARC Chapters (250+ local chapters)...', 'info');
                await loadRedCrossChapters();
            }, 1000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 2: Selecting Total Households vs Diversity Index...', 'info');
                    selectDemoVariables('Total_HH', 'Diversity');
                    
                    setTimeout(() => {
                        showStatus('Step 3: Mapping chapter-level patterns...', 'info');
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('Chapter demo complete! Each of 250+ chapters colored by households vs unemployment. Zoom in to explore!', 'success');
                        }, 2000);
                    }, 2000);
                }
            }, 8000);
        }
        
        async function runCountyDemo() {
            showStatus('⏳ County demo loading 3,142 counties - this may take 10-15 seconds...', 'info');
            
            setTimeout(async () => {
                showStatus('Step 1: Loading all 3,142 US counties with demographics...', 'info');
                await loadARCCounties();
            }, 1000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 2: Selecting Population vs Median Age...', 'info');
                    
                    const xSelect = document.getElementById('xVariable');
                    const ySelect = document.getElementById('yVariable');
                    
                    // Look for specific meaningful fields
                    let popFound = false;
                    let incFound = false;
                    
                    // Find population field
                    for (let i = 1; i < xSelect.options.length; i++) {
                        const optText = xSelect.options[i].text.toLowerCase();
                        const optValue = xSelect.options[i].value.toLowerCase();
                        if ((optText.includes('pop') && optText.includes('2023')) || 
                            optValue === 'pop_2023' || optValue === 'total_pop') {
                            xSelect.selectedIndex = i;
                            popFound = true;
                            console.log('Selected X:', xSelect.options[i].text);
                            break;
                        }
                    }
                    
                    // Find median household income
                    for (let i = 1; i < ySelect.options.length; i++) {
                        const optText = ySelect.options[i].text.toLowerCase();
                        const optValue = ySelect.options[i].value.toLowerCase();
                        if ((optText.includes('med') && optText.includes('inc')) || 
                            optValue === 'med_hh_inc_2023' || optValue === 'median_hh_income') {
                            ySelect.selectedIndex = i;
                            incFound = true;
                            console.log('Selected Y:', ySelect.options[i].text);
                            break;
                        }
                    }
                    
                    // Fallback if specific fields not found
                    if (!popFound) {
                        // Just pick first numeric field that isn't area/acres
                        for (let i = 1; i < xSelect.options.length; i++) {
                            const text = xSelect.options[i].text.toLowerCase();
                            if (!text.includes('acre') && !text.includes('area') && !text.includes('sqmi')) {
                                xSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    if (!incFound) {
                        // Pick a different field than X
                        for (let i = 1; i < ySelect.options.length; i++) {
                            const text = ySelect.options[i].text.toLowerCase();
                            if (!text.includes('acre') && !text.includes('area') && !text.includes('sqmi') && 
                                i !== xSelect.selectedIndex) {
                                ySelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    setTimeout(() => {
                        showStatus('Step 3: Creating detailed county map (please wait)...', 'info');
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('County demo complete! All 3,142 counties colored by Population vs Income. Purple = populous & wealthy. Zoom to your area!', 'success');
                        }, 3000);
                    }, 3000);
                }
            }, 12000);
        }
        
        async function runCSVDivisionDemo() {
            showStatus('CSV Demo: I\'ll load sample data and match it to divisions...', 'info');
            
            // First switch to CSV tab properly
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector('.tab[onclick*="csv"]').classList.add('active');
            document.getElementById('csv-tab').classList.add('active');
            
            setTimeout(() => {
                showStatus('Step 1: Loading sample division performance data...', 'info');
                loadSampleCSV('divisions');
            }, 1000);
            
            setTimeout(async () => {
                showStatus('Step 2: Matching CSV data to division boundaries...', 'info');
                await matchAndMergeData();
            }, 3000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 3: Comparing CSV metrics with geography demographics...', 'info');
                    
                    // Select one CSV field and one geography field
                    const xSelect = document.getElementById('xVariable');
                    const ySelect = document.getElementById('yVariable');
                    
                    // Find CSV fields (they have CSV_ prefix)
                    for (let i = 1; i < xSelect.options.length; i++) {
                        if (xSelect.options[i].value.includes('CSV_')) {
                            xSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // Find a geography field for Y
                    for (let i = 1; i < ySelect.options.length; i++) {
                        if (!ySelect.options[i].value.includes('CSV_') && ySelect.options[i].text.includes('Pop')) {
                            ySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    setTimeout(() => {
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('CSV demo complete! This shows how to combine your data with geographic demographics!', 'success');
                        }, 2000);
                    }, 2000);
                }
            }, 8000);
        }
        
        async function runCSVCountyDemo() {
            showStatus('CSV County Demo: Loading sample county data and matching to geography...', 'info');
            
            // First switch to CSV tab properly
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector('.tab[onclick*="csv"]').classList.add('active');
            document.getElementById('csv-tab').classList.add('active');
            
            setTimeout(() => {
                showStatus('Step 1: Loading sample county test data with FIPS codes...', 'info');
                loadSampleCSV('counties');
            }, 1000);
            
            setTimeout(async () => {
                showStatus('Step 2: Matching by FIPS code to county boundaries...', 'info');
                await matchAndMergeData();
            }, 3000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 3: Analyzing CSV test rates vs county demographics...', 'info');
                    
                    // Select CSV TestRate and geography income
                    const xSelect = document.getElementById('xVariable');
                    const ySelect = document.getElementById('yVariable');
                    
                    for (let i = 1; i < xSelect.options.length; i++) {
                        if (xSelect.options[i].value === 'CSV_TestRate') {
                            xSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    for (let i = 1; i < ySelect.options.length; i++) {
                        if (ySelect.options[i].text.includes('Inc') && !ySelect.options[i].value.includes('CSV_')) {
                            ySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    setTimeout(() => {
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('CSV County demo complete! Shows 10 sample counties matched by FIPS. Your CSV can have thousands!', 'success');
                        }, 2000);
                    }, 2000);
                }
            }, 10000);
        }
        
        function selectDemoVariables(xKeyword, yKeyword) {
            const xSelect = document.getElementById('xVariable');
            const ySelect = document.getElementById('yVariable');
            
            // Helper to check if option represents a numeric field
            function isNumericField(optionText, optionValue) {
                const text = optionText.toLowerCase();
                // Skip non-numeric fields
                const skipWords = ['acre', 'sqmi', 'area', 'name', 'state', 'county', 'region', 
                                  'division', 'chapter', 'code', 'id', 'abbr', 'fips'];
                if (skipWords.some(word => text.includes(word))) {
                    return false;
                }
                
                // Look for numeric indicators
                const numericWords = ['pop', 'inc', 'med', 'avg', 'total', 'sum', 'count', 
                                     'percent', 'rate', 'households', 'alice', 'poverty'];
                return numericWords.some(word => text.includes(word));
            }
            
            let xIndex = -1;
            let yIndex = -1;
            
            // Find matching numeric variables
            for (let i = 1; i < xSelect.options.length; i++) {
                const opt = xSelect.options[i];
                if (isNumericField(opt.text, opt.value) && 
                    opt.text.toLowerCase().includes(xKeyword.toLowerCase())) {
                    xIndex = i;
                    break;
                }
            }
            
            // If no keyword match, find first good numeric field
            if (xIndex === -1) {
                for (let i = 1; i < xSelect.options.length; i++) {
                    if (isNumericField(xSelect.options[i].text, xSelect.options[i].value)) {
                        xIndex = i;
                        break;
                    }
                }
            }
            
            // Find Y variable (different from X)
            for (let i = 1; i < ySelect.options.length; i++) {
                const opt = ySelect.options[i];
                if (i !== xIndex && isNumericField(opt.text, opt.value) && 
                    opt.text.toLowerCase().includes(yKeyword.toLowerCase())) {
                    yIndex = i;
                    break;
                }
            }
            
            // If no keyword match, find a different numeric field
            if (yIndex === -1) {
                for (let i = 1; i < ySelect.options.length; i++) {
                    if (i !== xIndex && isNumericField(ySelect.options[i].text, ySelect.options[i].value)) {
                        yIndex = i;
                        break;
                    }
                }
            }
            
            // Set to safe defaults if nothing found
            xSelect.selectedIndex = xIndex > 0 ? xIndex : 1;
            ySelect.selectedIndex = yIndex > 0 ? yIndex : 2;
        }
        
        async function runALICEFloridaDemo() {
            showStatus('🌟 ALICE Demo: Loading real Florida ALICE data - this shows financial vulnerability by county...', 'info');
            
            setTimeout(() => {
                // Switch to CSV tab
                switchTab('csv');
                document.querySelector('.tab[onclick*="csv"]').classList.add('active');
                document.querySelector('.tab[onclick*="arcgis"]').classList.remove('active');
                document.getElementById('csv-tab').classList.add('active');
                document.getElementById('arcgis-tab').classList.remove('active');
                
                showStatus('Step 1: Loading 2023 Florida County ALICE Data (67 counties)...', 'info');
                
                // Load the actual ALICE file
                const aliceFile = new File(
                    [''], // We'll simulate the file upload
                    '2023 Florida County Alice Data.csv',
                    { type: 'text/csv' }
                );
                
                // Instead, let's create sample ALICE data based on the real structure
                const aliceData = [
                    { County: 'Miami-Dade', Households: 958884, 'Poverty Households': 145826, 'ALICE Households': 365162, 'Above ALICE Households': 447896 },
                    { County: 'Broward', Households: 758853, 'Poverty Households': 102269, 'ALICE Households': 277598, 'Above ALICE Households': 378986 },
                    { County: 'Palm Beach', Households: 620000, 'Poverty Households': 75000, 'ALICE Households': 210000, 'Above ALICE Households': 335000 },
                    { County: 'Hillsborough', Households: 574932, 'Poverty Households': 86239, 'ALICE Households': 195877, 'Above ALICE Households': 292816 },
                    { County: 'Orange', Households: 534000, 'Poverty Households': 80100, 'ALICE Households': 181560, 'Above ALICE Households': 272340 },
                    { County: 'Pinellas', Households: 460000, 'Poverty Households': 59800, 'ALICE Households': 156400, 'Above ALICE Households': 243800 },
                    { County: 'Duval', Households: 428020, 'Poverty Households': 61768, 'ALICE Households': 118775, 'Above ALICE Households': 247477 },
                    { County: 'Lee', Households: 340000, 'Poverty Households': 40800, 'ALICE Households': 115600, 'Above ALICE Households': 183600 },
                    { County: 'Polk', Households: 285000, 'Poverty Households': 42750, 'ALICE Households': 96900, 'Above ALICE Households': 145350 },
                    { County: 'Brevard', Households: 258656, 'Poverty Households': 25275, 'ALICE Households': 82832, 'Above ALICE Households': 150549 },
                    { County: 'Volusia', Households: 240000, 'Poverty Households': 36000, 'ALICE Households': 81600, 'Above ALICE Households': 122400 },
                    { County: 'Pasco', Households: 230000, 'Poverty Households': 29900, 'ALICE Households': 78200, 'Above ALICE Households': 121900 },
                    { County: 'Seminole', Households: 185000, 'Poverty Households': 18500, 'ALICE Households': 55500, 'Above ALICE Households': 111000 },
                    { County: 'Sarasota', Households: 200000, 'Poverty Households': 22000, 'ALICE Households': 68000, 'Above ALICE Households': 110000 },
                    { County: 'Marion', Households: 170000, 'Poverty Households': 27200, 'ALICE Households': 57800, 'Above ALICE Households': 85000 }
                ];
                
                // Calculate ALICE percentage for each county
                aliceData.forEach(row => {
                    row['ALICE_Percent'] = ((row['ALICE Households'] / row.Households) * 100).toFixed(1);
                    row['Poverty_Percent'] = ((row['Poverty Households'] / row.Households) * 100).toFixed(1);
                    row['Vulnerable_Percent'] = (((row['ALICE Households'] + row['Poverty Households']) / row.Households) * 100).toFixed(1);
                });
                
                csvData = aliceData;
                csvFields = Object.keys(aliceData[0]);
                
                // Update dropdowns
                const csvMatchField = document.getElementById('csvMatchField');
                csvMatchField.innerHTML = '<option value="">-- Select CSV field to match --</option>';
                csvFields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    csvMatchField.appendChild(option);
                });
                
                document.getElementById('csvFieldMapping').style.display = 'block';
                
                // Auto-select matching fields
                document.getElementById('geographyType').value = 'arc_counties';
                handleGeographyChange();
                
                setTimeout(() => {
                    document.getElementById('csvMatchField').value = 'County';
                    document.getElementById('geoMatchField').value = 'County';
                }, 500);
                
                showStatus('ALICE data loaded! This shows Asset Limited, Income Constrained, Employed households...', 'success');
            }, 1000);
            
            setTimeout(() => {
                showStatus('Step 2: Matching ALICE data to Florida county boundaries...', 'info');
                matchAndMergeData();
            }, 4000);
            
            setTimeout(() => {
                if (document.getElementById('xVariable').options.length > 1) {
                    showStatus('Step 3: Comparing ALICE vulnerability % vs Median Income...', 'info');
                    
                    const xSelect = document.getElementById('xVariable');
                    const ySelect = document.getElementById('yVariable');
                    
                    // Find ALICE percent field
                    for (let i = 1; i < xSelect.options.length; i++) {
                        if (xSelect.options[i].value === 'CSV_Vulnerable_Percent') {
                            xSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // Find median income field
                    for (let i = 1; i < ySelect.options.length; i++) {
                        if (ySelect.options[i].text.includes('Med') && ySelect.options[i].text.includes('Inc')) {
                            ySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    setTimeout(() => {
                        generateBivariateMap();
                        
                        setTimeout(() => {
                            showStatus('ALICE Demo complete! Purple areas = High vulnerability + High income (interesting paradox!). This data is crucial for Red Cross disaster planning!', 'success');
                        }, 2000);
                    }, 2000);
                }
            }, 11000);
        }
        
        // Add helper text when hovering over complex elements
        function addHelperTooltips() {
            // Add titles to buttons for hover help
            document.querySelectorAll('.service-preset').forEach(btn => {
                btn.title = 'Click to load this geography layer with all its demographic data';
            });
            
            document.getElementById('xVariable').title = 'Choose your first variable (X-axis) - this will be one dimension of your analysis';
            document.getElementById('yVariable').title = 'Choose your second variable (Y-axis) - this will be compared against the X variable';
        }
        
        // Toggle accordion in popup
        function toggleAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            const arrow = document.getElementById(accordionId + '_arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
                arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
                arrow.textContent = '▼';
            }
        }
        
        // Initialize map on load
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
            addHelperTooltips();
            
            // Show welcome message
            setTimeout(() => {
                showStatus('Welcome! Click "Run Demo" above for a quick tutorial, or click any colored button to start exploring!', 'info');
            }, 1000);
        });
    </script>
</body>
</html>